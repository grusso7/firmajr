

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="it" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="it" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>digital_signature.pdf_builder &mdash; FirmaJR 0.0.1 documentazione</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Indice" href="../../genindex.html" />
    <link rel="search" title="Cerca" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> FirmaJR
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contenuti:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Per iniziare a sviluppare</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../flusso.html">Flusso di esecuzione</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../digital_signature.html">Documentazione API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">FirmaJR</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Codice del modulo</a> &raquo;</li>
        
      <li>digital_signature.pdf_builder</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Codice sorgente per digital_signature.pdf_builder</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pdf_signer</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">zlib</span> <span class="kn">import</span> <span class="n">compress</span>
<span class="kn">from</span> <span class="nn">pdfminer.pdfdocument</span> <span class="kn">import</span> <span class="n">PDFDocument</span>
<span class="kn">from</span> <span class="nn">pdfminer.pdfparser</span> <span class="kn">import</span> <span class="n">PDFParser</span>
<span class="kn">from</span> <span class="nn">PyKCS11</span> <span class="kn">import</span> <span class="n">Mechanism</span><span class="p">,</span> <span class="n">LowLevel</span>
<span class="kn">from</span> <span class="nn">asn1crypto.x509</span> <span class="kn">import</span> <span class="n">Certificate</span>

<span class="kn">from</span> <span class="nn">my_config_loader</span> <span class="kn">import</span> <span class="n">MyConfigLoader</span><span class="p">,</span> <span class="n">BASE_PATH</span>
<span class="kn">from</span> <span class="nn">my_logger</span> <span class="kn">import</span> <span class="n">MyLogger</span>

<span class="n">FRM_STREAM</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;q 1 0 0 1 0 0 cm /FRM Do Q</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="n">N0_N2_STREAM</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;q 1 0 0 1 0 0 cm /n0 Do Q</span><span class="se">\n</span><span class="s1">q 1 0 0 1 0 0 cm /n2 Do Q</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="n">DSBLANK_STREAM</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;% DSBlank</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="n">STREAM_WITH_NAME</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;BT</span><span class="se">\n</span><span class="s1">1 0 0 1 2 28 Tm</span><span class="se">\n</span><span class="s1">/F1 12 Tf</span><span class="se">\n</span><span class="s1">()Tj</span><span class="se">\n</span><span class="s1">1 0 0 1 2 16 Tm</span><span class="se">\n</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)Tj</span><span class="se">\n</span><span class="s1">ET</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="n">sig_names</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">MyLogger</span><span class="p">()</span><span class="o">.</span><span class="n">my_logger</span><span class="p">()</span>


<span class="c1"># Custom exceptions:</span>
<div class="viewcode-block" id="PDFCreationError"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.PDFCreationError">[documenti]</a><span class="k">class</span> <span class="nc">PDFCreationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Raised when failing to create pdf &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="PDFSigningError"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.PDFSigningError">[documenti]</a><span class="k">class</span> <span class="nc">PDFSigningError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Raised when failing to sign pdf &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="Signature"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.Signature">[documenti]</a><span class="k">class</span> <span class="nc">Signature</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span></div>


<div class="viewcode-block" id="SignedData"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.SignedData">[documenti]</a><span class="k">class</span> <span class="nc">SignedData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

<div class="viewcode-block" id="SignedData.aligned"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.SignedData.aligned">[documenti]</a>    <span class="k">def</span> <span class="nf">aligned</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">csize</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x5000</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">nb</span> <span class="o">=</span> <span class="n">csize</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;0&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">csize</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="SignedData.getdata"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.SignedData.getdata">[documenti]</a>    <span class="k">def</span> <span class="nf">getdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdfdata1</span><span class="p">,</span> <span class="n">objid</span><span class="p">,</span> <span class="n">startxref</span><span class="p">,</span> <span class="n">document</span><span class="p">):</span>
        <span class="n">i0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">xref</span> <span class="ow">in</span> <span class="n">document</span><span class="o">.</span><span class="n">xrefs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="p">(</span><span class="n">strmid</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">genno</span><span class="p">)</span> <span class="o">=</span> <span class="n">xref</span><span class="o">.</span><span class="n">get_pos</span><span class="p">(</span><span class="n">objid</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="n">index</span>
            <span class="k">break</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">startxref</span>
        <span class="k">for</span> <span class="n">xref</span> <span class="ow">in</span> <span class="n">document</span><span class="o">.</span><span class="n">xrefs</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">xref</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="n">i0</span><span class="p">:</span>
                    <span class="n">i1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i1</span> <span class="o">&lt;=</span> <span class="n">i0</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pdfdata1</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">pdfdata1</span><span class="p">)]</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&lt;&lt;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt;&gt;</span><span class="se">\r</span><span class="s1">endobj&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pdfdata1</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&lt;&lt;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt;&gt;&#39;</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="SignedData.get_sig_names"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.SignedData.get_sig_names">[documenti]</a>    <span class="k">def</span> <span class="nf">get_sig_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sig_names</span></div>

<div class="viewcode-block" id="SignedData.get_signature_names"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.SignedData.get_signature_names">[documenti]</a>    <span class="k">def</span> <span class="nf">get_signature_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">):</span>
        <span class="n">sorter</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">acrofields</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;AcroForm&#39;</span><span class="p">][</span><span class="s1">&#39;Fields&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">acrofields</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="n">acrofields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">acroform_objid</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;AcroForm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">objid</span>
                <span class="n">acrofields</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">getobj</span><span class="p">(</span><span class="n">acroform_objid</span><span class="p">)[</span><span class="s1">&#39;Fields&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;no other signatures found on document&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">acrofields</span><span class="p">:</span>
            <span class="n">field_obj</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">getobj</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">objid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field_obj</span><span class="p">[</span><span class="s1">&#39;FT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Sig&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field_obj</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]:</span>
                    <span class="n">signed_field</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">getobj</span><span class="p">(</span><span class="n">field_obj</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">objid</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">signed_field</span><span class="p">[</span><span class="s1">&#39;Contents&#39;</span><span class="p">]:</span>
                        <span class="n">byte_range</span> <span class="o">=</span> <span class="n">signed_field</span><span class="p">[</span><span class="s1">&#39;ByteRange&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">byte_range</span><span class="p">:</span>
                            <span class="n">b_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">byte_range</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">b_size</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">length</span> <span class="o">=</span> <span class="n">byte_range</span><span class="p">[</span><span class="n">b_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">byte_range</span><span class="p">[</span><span class="n">b_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
                                <span class="n">sorter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Signature</span><span class="p">(</span><span class="n">field_obj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="p">[</span><span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
                                <span class="c1">#  sorter.append(Signature(&#39;signature1&#39;, [length*3, 0]))  # test purpose</span>
                                <span class="c1">#  sorter.append(Signature(&#39;signature2&#39;, [length*2, 0]))  # test purpose</span>
        <span class="k">if</span> <span class="n">sorter</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sorter</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorter</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">pos</span>
            <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">sig_names</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>

        <span class="k">return</span> <span class="n">sig_names</span></div>

<div class="viewcode-block" id="SignedData.get_rect_array"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.SignedData.get_rect_array">[documenti]</a>    <span class="k">def</span> <span class="nf">get_rect_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pagedata</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="n">mbx</span> <span class="o">=</span> <span class="n">pagedata</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;MediaBox&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s1">&#39;MediaBox&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">mby</span> <span class="o">=</span> <span class="n">pagedata</span><span class="p">[</span><span class="n">mbx</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">pagedata</span><span class="p">)]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
        <span class="n">mediabox</span> <span class="o">=</span> <span class="n">pagedata</span><span class="p">[</span><span class="n">mbx</span><span class="p">:</span><span class="n">mbx</span> <span class="o">+</span> <span class="n">mby</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">llx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mediabox</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;padding_width&#39;</span><span class="p">]</span>
        <span class="n">lly</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mediabox</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;padding_height&#39;</span><span class="p">]</span>
        <span class="n">urx</span> <span class="o">=</span> <span class="n">llx</span> <span class="o">+</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span>
        <span class="n">ury</span> <span class="o">=</span> <span class="n">lly</span> <span class="o">+</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">llx</span><span class="p">,</span> <span class="n">lly</span><span class="p">,</span> <span class="n">urx</span><span class="p">,</span> <span class="n">ury</span><span class="p">]</span></div>

<div class="viewcode-block" id="SignedData.get_acrofields"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.SignedData.get_acrofields">[documenti]</a>    <span class="k">def</span> <span class="nf">get_acrofields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">acrofields</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;AcroForm&#39;</span><span class="p">][</span><span class="s1">&#39;Fields&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">acrofields</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="n">acrofields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">acroform_objid</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;AcroForm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">objid</span>
                <span class="n">acrofields</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">getobj</span><span class="p">(</span><span class="n">acroform_objid</span><span class="p">)[</span><span class="s1">&#39;Fields&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PDFCreationError</span><span class="p">(</span><span class="s1">&#39;Fields not found in AcroForm tag&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">acrofields</span></div>

<div class="viewcode-block" id="SignedData.get_annots_fields_values"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.SignedData.get_annots_fields_values">[documenti]</a>    <span class="k">def</span> <span class="nf">get_annots_fields_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acrofields</span><span class="p">):</span>
        <span class="n">fields_values</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">acrofields</span><span class="p">:</span>
            <span class="n">fields_values</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> 0 R &#39;</span> <span class="o">%</span> <span class="n">field</span><span class="o">.</span><span class="n">objid</span>
        <span class="k">return</span> <span class="n">fields_values</span></div>

<div class="viewcode-block" id="SignedData.get_new_pagedata"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.SignedData.get_new_pagedata">[documenti]</a>    <span class="k">def</span> <span class="nf">get_new_pagedata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pagedata</span><span class="p">):</span>
        <span class="n">annot_start</span> <span class="o">=</span> <span class="n">pagedata</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/Annots&#39;</span><span class="p">)</span>
        <span class="n">annot_end</span> <span class="o">=</span> <span class="n">pagedata</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;]/&#39;</span><span class="p">,</span> <span class="n">annot_start</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pagedata</span><span class="p">[:</span><span class="n">annot_start</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="si">%s%d</span><span class="s1"> 0 R&#39;</span> <span class="o">+</span> <span class="n">pagedata</span><span class="p">[</span><span class="n">annot_end</span><span class="p">:]</span></div>

<div class="viewcode-block" id="SignedData.get_new_rootdata"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.SignedData.get_new_rootdata">[documenti]</a>    <span class="k">def</span> <span class="nf">get_new_rootdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rootdata</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_rootdata</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">rb</span><span class="s1">&#39;/SigFlags\s?\s?.*?[0-9]+&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/SigFlags </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">rootdata</span><span class="p">)</span>
            <span class="n">new_rootdata</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">rb</span><span class="s1">&#39;/Fields\s?\[\s?.*?]&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Fields[</span><span class="si">%s%d</span><span class="s1"> 0 R]&#39;</span><span class="p">,</span> <span class="n">new_rootdata</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PDFCreationError</span><span class="p">(</span><span class="s1">&#39;Failing during SigFlags and Fields changes&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_rootdata</span></div>

<div class="viewcode-block" id="SignedData.makeobj"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.SignedData.makeobj">[documenti]</a>    <span class="k">def</span> <span class="nf">makeobj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">no</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> 0 obj</span><span class="se">\n</span><span class="s1">&lt;&lt;&#39;</span> <span class="o">%</span> <span class="n">no</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;&gt;&gt;</span><span class="se">\n</span><span class="s1">endobj</span><span class="se">\n</span><span class="s1">&#39;</span></div>

<div class="viewcode-block" id="SignedData.makeobj_stream"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.SignedData.makeobj_stream">[documenti]</a>    <span class="k">def</span> <span class="nf">makeobj_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">no</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> 0 obj</span><span class="se">\n</span><span class="s1">&lt;&lt;&#39;</span> <span class="o">%</span> <span class="n">no</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;&gt;&gt;stream</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">stream</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">endstream</span><span class="se">\n</span><span class="s1">endobj</span><span class="se">\n</span><span class="s1">&#39;</span></div>

    <span class="c1"># Contains the font stream encoded</span>
<div class="viewcode-block" id="SignedData.makeobj_font_stream"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.SignedData.makeobj_font_stream">[documenti]</a>    <span class="k">def</span> <span class="nf">makeobj_font_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">no</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> 0 obj</span><span class="se">\n</span><span class="s1">&lt;&lt;&#39;</span> <span class="o">%</span> <span class="n">no</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;&gt;&gt;&#39;</span> <span class="o">+</span> <span class="n">stream</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">endobj</span><span class="se">\n</span><span class="s1">&#39;</span></div>

<div class="viewcode-block" id="SignedData.make_visible_sig_objs"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.SignedData.make_visible_sig_objs">[documenti]</a>    <span class="k">def</span> <span class="nf">make_visible_sig_objs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">udct</span><span class="p">,</span> <span class="n">no</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">pagedata</span><span class="p">,</span> <span class="n">infodata</span><span class="p">,</span> <span class="n">rootdata</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">,</span> <span class="n">rect</span><span class="p">,</span> <span class="n">zeros</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;load font&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_PATH</span><span class="p">,</span> <span class="s1">&#39;encoded_font.bin&#39;</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">font_file</span><span class="p">:</span>
            <span class="n">font</span> <span class="o">=</span> <span class="n">font_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;unicode-escape&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">)</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/Annots[</span><span class="si">%d</span><span class="s1"> 0 R]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">pagedata</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">infodata</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/AcroForm&lt;&lt;/SigFlags </span><span class="si">%d</span><span class="s1">/Fields[</span><span class="si">%d</span><span class="s1"> 0 R]/DA(/Helv 0 Tf 0 g)/DR &lt;&lt;/Font&lt;&lt;/ZaDb </span><span class="si">%d</span><span class="s1"> 0 R/Helv </span><span class="si">%d</span><span class="s1"> 0 R&gt;&gt;&gt;&gt;&gt;&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">udct</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;sigflags&#39;</span><span class="p">],</span> <span class="n">no</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">no</span> <span class="o">+</span> <span class="mi">11</span><span class="p">,</span> <span class="n">no</span> <span class="o">+</span> <span class="mi">12</span><span class="p">))</span> <span class="o">+</span> <span class="n">rootdata</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="sa">b</span><span class="s1">&#39;/AP&lt;&lt;/N </span><span class="si">%d</span><span class="s1"> 0 R&gt;&gt;/Type/Annot/F 132/DA(/Arial 0 Tf 0 g)/FT/Sig/DR &lt;&lt;&gt;&gt;/P </span><span class="si">%d</span><span class="s1"> 0 R/Rect[</span><span class="si">%.2f</span><span class="s1"> </span><span class="si">%.2f</span><span class="s1"> </span><span class="si">%.2f</span><span class="s1"> </span><span class="si">%.2f</span><span class="s1">]/Subtype/Widget/T(</span><span class="si">%s</span><span class="s1">)/V </span><span class="si">%d</span><span class="s1"> 0 R&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">rect</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rect</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rect</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">udct</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;sign_name&#39;</span><span class="p">],</span> <span class="n">no</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj_stream</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Subtype/Form/Filter/FlateDecode/Type/XObject/Matrix [1 0 0 1 0 0]/FormType 1/Resources&lt;&lt;/ProcSet [/PDF /Text /ImageB /ImageC /ImageI]/XObject&lt;&lt;/FRM </span><span class="si">%d</span><span class="s1"> 0 R&gt;&gt;&gt;&gt;/BBox[0 0 200 60]/Length 29&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">5</span><span class="p">),</span> <span class="n">compress</span><span class="p">(</span><span class="n">FRM_STREAM</span><span class="p">)),</span>
            <span class="sa">b</span><span class="s1">&#39;stream</span><span class="se">\n\x78\x9C\x03\x00\x00\x00\x00\x01\n</span><span class="s1">endstream</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
                 <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/ByteRange [0000000000 0000000000 0000000000 0000000000]/Name(</span><span class="si">%s</span><span class="s1">)/Filter/Adobe.PPKLite/M(D:</span><span class="si">%s</span><span class="s1">)/SubFilter/ETSI.CAdES.detached/Type/Sig/FT/Sig/Contents &lt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">udct</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">udct</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;signingdate&#39;</span><span class="p">]))</span> <span class="o">+</span> <span class="n">zeros</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;&gt;&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj_stream</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Subtype/Form/Filter/FlateDecode/Type/XObject/Matrix [1 0 0 1 0 0]/FormType 1/Resources&lt;&lt;/ProcSet [/PDF /Text /ImageB /ImageC /ImageI]/XObject&lt;&lt;/n0 </span><span class="si">%d</span><span class="s1"> 0 R/n2 </span><span class="si">%d</span><span class="s1"> 0 R&gt;&gt;&gt;&gt;/BBox[0 0 200 60]/Length 34&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="n">no</span> <span class="o">+</span> <span class="mi">7</span><span class="p">),</span> <span class="n">compress</span><span class="p">(</span><span class="n">N0_N2_STREAM</span><span class="p">)),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj_stream</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Subtype/Form/Filter/FlateDecode/Type/XObject/Matrix [1 0 0 1 0 0]/FormType 1/Resources&lt;&lt;/ProcSet [/PDF /Text /ImageB /ImageC /ImageI]&gt;&gt;/BBox[0 0 100 100]/Length 18&#39;</span><span class="p">,</span> <span class="n">compress</span><span class="p">(</span><span class="n">DSBLANK_STREAM</span><span class="p">)),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj_stream</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Subtype/Form/Filter/FlateDecode/Type/XObject/Matrix [1 0 0 1 0 0]/FormType 1/Resources&lt;&lt;/ProcSet [/PDF /Text /ImageB /ImageC /ImageI]/Font&lt;&lt;/F1 </span><span class="si">%d</span><span class="s1"> 0 R&gt;&gt;&gt;&gt;/BBox[0 0 200 60]/Length </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">stream_name</span><span class="p">)),</span> <span class="n">stream_name</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Subtype/TrueType/FirstChar 32/Type/Font/BaseFont/ArialMT/FontDescriptor </span><span class="si">%d</span><span class="s1"> 0 R/Encoding/WinAnsiEncoding/LastChar 126/Widths[277 277 354 556 556 889 666 190 333 333 389 583 277 333 277 277 556 556 556 556 556 556 556 556 556 556 277 277 583 583 583 556 1015 666 666 722 722 666 610 777 722 277 500 666 556 833 722 777 666 777 722 666 610 722 666 943 666 666 610 277 277 277 469 556 333 556 556 500 556 556 277 556 556 222 222 500 222 833 556 556 556 556 333 500 277 556 500 722 500 500 500 333 259 333 583]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">9</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Descent -210/CapHeight 716/StemV 80/Type/FontDescriptor/FontFile2 </span><span class="si">%d</span><span class="s1"> 0 R/Flags 32/FontBBox[-664 -324 2000 1039]/FontName/ArialMT/ItalicAngle 0/Ascent 728&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj_font_stream</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Length1 96488/Filter/FlateDecode/Length 44982&#39;</span><span class="p">,</span> <span class="n">font</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">11</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Name/ZaDb/Subtype/Type1/Type/Font/BaseFont/ZapfDingbats&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Name/Helv/Subtype/Type1/Type/Font/BaseFont/Helvetica/Encoding/WinAnsiEncoding&#39;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">objs</span></div>

<div class="viewcode-block" id="SignedData.make_multi_visible_sig_objs"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.SignedData.make_multi_visible_sig_objs">[documenti]</a>    <span class="k">def</span> <span class="nf">make_multi_visible_sig_objs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">,</span> <span class="n">udct</span><span class="p">,</span> <span class="n">no</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">pagedata</span><span class="p">,</span> <span class="n">infodata</span><span class="p">,</span> <span class="n">rootdata</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">,</span> <span class="n">rect</span><span class="p">,</span> <span class="n">zeros</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;load font&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_PATH</span><span class="p">,</span> <span class="s1">&#39;encoded_font.bin&#39;</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">font_file</span><span class="p">:</span>
            <span class="n">font</span> <span class="o">=</span> <span class="n">font_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;unicode-escape&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">)</span>

        <span class="n">acrofields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acrofields</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
        <span class="n">fields_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_annots_fields_values</span><span class="p">(</span><span class="n">acrofields</span><span class="p">)</span>
        <span class="n">parent_objid</span> <span class="o">=</span> <span class="n">acrofields</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">acrofields</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">objid</span>
        <span class="n">new_pagedata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_pagedata</span><span class="p">(</span><span class="n">pagedata</span><span class="p">)</span>
        <span class="n">new_rootdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_rootdata</span><span class="p">(</span><span class="n">rootdata</span><span class="p">)</span>

        <span class="n">objs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">new_pagedata</span> <span class="o">%</span> <span class="p">(</span><span class="n">fields_values</span><span class="p">,</span> <span class="n">no</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">infodata</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_rootdata</span> <span class="o">%</span> <span class="p">(</span><span class="n">udct</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;sigflags&#39;</span><span class="p">],</span> <span class="n">fields_values</span><span class="p">,</span> <span class="n">no</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                     <span class="sa">b</span><span class="s1">&#39;/AP&lt;&lt;/N </span><span class="si">%d</span><span class="s1"> 0 R&gt;&gt;/Type/Annot/F 132/DA(/Arial 0 Tf 0 g)/FT/Sig/DR &lt;&lt;&gt;&gt;/P </span><span class="si">%d</span><span class="s1"> 0 R/Rect[</span><span class="si">%.2f</span><span class="s1"> </span><span class="si">%.2f</span><span class="s1"> </span><span class="si">%.2f</span><span class="s1"> </span><span class="si">%.2f</span><span class="s1">]/Subtype/Widget/T(</span><span class="si">%s</span><span class="s1">)/V </span><span class="si">%d</span><span class="s1"> 0 R/Parent </span><span class="si">%d</span><span class="s1"> 0 R&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">rect</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rect</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rect</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">udct</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;sign_name&#39;</span><span class="p">],</span> <span class="n">no</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">parent_objid</span><span class="p">)),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj_stream</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Subtype/Form/Filter/FlateDecode/Type/XObject/Matrix [1 0 0 1 0 0]/FormType 1/Resources&lt;&lt;/ProcSet [/PDF /Text /ImageB /ImageC /ImageI]/XObject&lt;&lt;/FRM </span><span class="si">%d</span><span class="s1"> 0 R&gt;&gt;&gt;&gt;/BBox[0 0 200 60]/Length 29&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">5</span><span class="p">),</span> <span class="n">compress</span><span class="p">(</span><span class="n">FRM_STREAM</span><span class="p">)),</span>
            <span class="sa">b</span><span class="s1">&#39;stream</span><span class="se">\n\x78\x9C\x03\x00\x00\x00\x00\x01\n</span><span class="s1">endstream</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
                 <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/ByteRange [0000000000 0000000000 0000000000 0000000000]/Name(</span><span class="si">%s</span><span class="s1">)/Filter/Adobe.PPKLite/M(D:</span><span class="si">%s</span><span class="s1">)/SubFilter/ETSI.CAdES.detached/Type/Sig/FT/Sig/Contents &lt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">udct</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">udct</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;signingdate&#39;</span><span class="p">]))</span> <span class="o">+</span> <span class="n">zeros</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;&gt;&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj_stream</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Subtype/Form/Filter/FlateDecode/Type/XObject/Matrix [1 0 0 1 0 0]/FormType 1/Resources&lt;&lt;/ProcSet [/PDF /Text /ImageB /ImageC /ImageI]/XObject&lt;&lt;/n0 </span><span class="si">%d</span><span class="s1"> 0 R/n2 </span><span class="si">%d</span><span class="s1"> 0 R&gt;&gt;&gt;&gt;/BBox[0 0 200 60]/Length 34&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="n">no</span> <span class="o">+</span> <span class="mi">7</span><span class="p">),</span> <span class="n">compress</span><span class="p">(</span><span class="n">N0_N2_STREAM</span><span class="p">)),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj_stream</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Subtype/Form/Filter/FlateDecode/Type/XObject/Matrix [1 0 0 1 0 0]/FormType 1/Resources&lt;&lt;/ProcSet [/PDF /Text /ImageB /ImageC /ImageI]&gt;&gt;/BBox[0 0 100 100]/Length 18&#39;</span><span class="p">,</span> <span class="n">compress</span><span class="p">(</span><span class="n">DSBLANK_STREAM</span><span class="p">)),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj_stream</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Subtype/Form/Filter/FlateDecode/Type/XObject/Matrix [1 0 0 1 0 0]/FormType 1/Resources&lt;&lt;/ProcSet [/PDF /Text /ImageB /ImageC /ImageI]/Font&lt;&lt;/F1 </span><span class="si">%d</span><span class="s1"> 0 R&gt;&gt;&gt;&gt;/BBox[0 0 200 60]/Length </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">stream_name</span><span class="p">)),</span> <span class="n">stream_name</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Subtype/TrueType/FirstChar 32/Type/Font/BaseFont/ArialMT/FontDescriptor </span><span class="si">%d</span><span class="s1"> 0 R/Encoding/WinAnsiEncoding/LastChar 126/Widths[277 277 354 556 556 889 666 190 333 333 389 583 277 333 277 277 556 556 556 556 556 556 556 556 556 556 277 277 583 583 583 556 1015 666 666 722 722 666 610 777 722 277 500 666 556 833 722 777 666 777 722 666 610 722 666 943 666 666 610 277 277 277 469 556 333 556 556 500 556 556 277 556 556 222 222 500 222 833 556 556 556 556 333 500 277 556 500 722 500 500 500 333 259 333 583]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">9</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Descent -210/CapHeight 716/StemV 80/Type/FontDescriptor/FontFile2 </span><span class="si">%d</span><span class="s1"> 0 R/Flags 32/FontBBox[-664 -324 2000 1039]/FontName/ArialMT/ItalicAngle 0/Ascent 728&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj_font_stream</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Length1 96488/Filter/FlateDecode/Length 44982&#39;</span><span class="p">,</span> <span class="n">font</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">objs</span></div>

<div class="viewcode-block" id="SignedData.make_invisible_sig_objs"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.SignedData.make_invisible_sig_objs">[documenti]</a>    <span class="k">def</span> <span class="nf">make_invisible_sig_objs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">udct</span><span class="p">,</span> <span class="n">no</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">pagedata</span><span class="p">,</span> <span class="n">infodata</span><span class="p">,</span> <span class="n">rootdata</span><span class="p">,</span> <span class="n">zeros</span><span class="p">):</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/Annots[</span><span class="si">%d</span><span class="s1"> 0 R]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">pagedata</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">infodata</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/AcroForm&lt;&lt;/SigFlags </span><span class="si">%d</span><span class="s1">/Fields[</span><span class="si">%d</span><span class="s1"> 0 R]&gt;&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">udct</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;sigflags&#39;</span><span class="p">],</span> <span class="n">no</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">rootdata</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/AP&lt;&lt;/N </span><span class="si">%d</span><span class="s1"> 0 R&gt;&gt;/Type/Annot/F 132/DA(/Arial 0 Tf 0 g)/FT/Sig/DR &lt;&lt;&gt;&gt;/P </span><span class="si">%d</span><span class="s1"> 0 R/Rect[0 0 0 0]/Subtype/Widget/T(</span><span class="si">%s</span><span class="s1">)/V </span><span class="si">%d</span><span class="s1"> 0 R&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">udct</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;sign_name&#39;</span><span class="p">],</span> <span class="n">no</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj_stream</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Subtype/Form/Filter/FlateDecode/Type/XObject/Matrix [1 0 0 1 0 0]/FormType 1/Resources&lt;&lt;/ProcSet [/PDF /Text /ImageB /ImageC /ImageI]&gt;&gt;/BBox[0 0 0 0]/Length 8&#39;</span><span class="p">,</span> <span class="n">compress</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)),</span>  <span class="c1"># Lenght 8 per firma invisibile</span>
            <span class="sa">b</span><span class="s1">&#39;stream</span><span class="se">\n\x78\x9C\x03\x00\x00\x00\x00\x01\n</span><span class="s1">endstream</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/Name(</span><span class="si">%s</span><span class="s1">)/Filter/Adobe.PPKLite/Type/Sig/ByteRange [0000000000 0000000000 0000000000 0000000000]/SubFilter/ETSI.CAdES.detached/FT/Sig/M(D:</span><span class="si">%s</span><span class="s1">)/Contents &lt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">udct</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">udct</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;signingdate&#39;</span><span class="p">]))</span> <span class="o">+</span> <span class="n">zeros</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;&gt;&#39;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">objs</span></div>

<div class="viewcode-block" id="SignedData.make_multi_inv_sig_objs"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.SignedData.make_multi_inv_sig_objs">[documenti]</a>    <span class="k">def</span> <span class="nf">make_multi_inv_sig_objs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">,</span> <span class="n">udct</span><span class="p">,</span> <span class="n">no</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">pagedata</span><span class="p">,</span> <span class="n">infodata</span><span class="p">,</span> <span class="n">rootdata</span><span class="p">,</span> <span class="n">zeros</span><span class="p">,</span> <span class="n">sig_number</span><span class="p">):</span>
        <span class="n">acrofields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acrofields</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
        <span class="n">fields_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_annots_fields_values</span><span class="p">(</span><span class="n">acrofields</span><span class="p">)</span>
        <span class="n">new_pagedata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_pagedata</span><span class="p">(</span><span class="n">pagedata</span><span class="p">)</span>
        <span class="n">new_rootdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_rootdata</span><span class="p">(</span><span class="n">rootdata</span><span class="p">)</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">new_pagedata</span> <span class="o">%</span> <span class="p">(</span><span class="n">fields_values</span><span class="p">,</span> <span class="n">no</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">infodata</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_rootdata</span> <span class="o">%</span> <span class="p">(</span><span class="n">udct</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;sigflags&#39;</span><span class="p">],</span> <span class="n">fields_values</span><span class="p">,</span> <span class="n">no</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/AP&lt;&lt;/N </span><span class="si">%d</span><span class="s1"> 0 R&gt;&gt;/Type/Annot/F 132/DA(/Arial 0 Tf 0 g)/FT/Sig/DR &lt;&lt;&gt;&gt;/P </span><span class="si">%d</span><span class="s1"> 0 R/Rect[0 0 0 0]/Subtype/Widget/T(</span><span class="si">%s%d</span><span class="s1">)/V </span><span class="si">%d</span><span class="s1"> 0 R&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">udct</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;sign_name&#39;</span><span class="p">],</span> <span class="n">sig_number</span><span class="p">,</span> <span class="n">no</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj_stream</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Subtype/Form/Filter/FlateDecode/Type/XObject/Matrix [1 0 0 1 0 0]/FormType 1/Resources&lt;&lt;/ProcSet [/PDF /Text /ImageB /ImageC /ImageI]&gt;&gt;/BBox[0 0 0 0]/Length 8&#39;</span><span class="p">,</span> <span class="n">compress</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)),</span>  <span class="c1"># Lenght 8 per firma invisibile</span>
            <span class="sa">b</span><span class="s1">&#39;stream</span><span class="se">\n\x78\x9C\x03\x00\x00\x00\x00\x01\n</span><span class="s1">endstream</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/Name(</span><span class="si">%s</span><span class="s1">)/Filter/Adobe.PPKLite/Type/Sig/ByteRange [0000000000 0000000000 0000000000 0000000000]/SubFilter/ETSI.CAdES.detached/FT/Sig/M(D:</span><span class="si">%s</span><span class="s1">)/Contents &lt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">udct</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">udct</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;signingdate&#39;</span><span class="p">]))</span> <span class="o">+</span> <span class="n">zeros</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">objs</span></div>

<div class="viewcode-block" id="SignedData.make_visible_xref"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.SignedData.make_visible_xref">[documenti]</a>    <span class="k">def</span> <span class="nf">make_visible_xref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s1">xref</span><span class="se">\n\</span>
<span class="si">%(page)d</span><span class="s1"> 1</span><span class="se">\n\</span>
<span class="si">%(p0)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(no)d</span><span class="s1"> 13</span><span class="se">\n\</span>
<span class="si">%(n0)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n1)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n2)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n3)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n4)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n5)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n6)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n7)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n8)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n9)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n10)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n11)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n12)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="s1">&#39;&#39;&#39;</span></div>

<div class="viewcode-block" id="SignedData.make_multi_visible_xref"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.SignedData.make_multi_visible_xref">[documenti]</a>    <span class="k">def</span> <span class="nf">make_multi_visible_xref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s1">xref</span><span class="se">\n\</span>
<span class="si">%(page)d</span><span class="s1"> 1</span><span class="se">\n\</span>
<span class="si">%(p0)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(no)d</span><span class="s1"> 11</span><span class="se">\n\</span>
<span class="si">%(n0)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n1)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n2)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n3)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n4)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n5)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n6)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n7)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n8)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n9)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n10)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="s1">&#39;&#39;&#39;</span></div>

<div class="viewcode-block" id="SignedData.make_invisible_xref"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.SignedData.make_invisible_xref">[documenti]</a>    <span class="k">def</span> <span class="nf">make_invisible_xref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s1">xref</span><span class="se">\n\</span>
<span class="si">%(page)d</span><span class="s1"> 1</span><span class="se">\n\</span>
<span class="si">%(p0)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(no)d</span><span class="s1"> 6</span><span class="se">\n\</span>
<span class="si">%(n0)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n1)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n2)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n3)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n4)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n5)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="s1">&#39;&#39;&#39;</span></div>

<div class="viewcode-block" id="SignedData.make_multi_inv_xref"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.SignedData.make_multi_inv_xref">[documenti]</a>    <span class="k">def</span> <span class="nf">make_multi_inv_xref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s1">xref</span><span class="se">\n\</span>
<span class="si">%(page)d</span><span class="s1"> 1</span><span class="se">\n\</span>
<span class="si">%(p0)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(no)d</span><span class="s1"> 5</span><span class="se">\n\</span>
<span class="si">%(n0)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n1)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n2)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n3)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="si">%(n4)010d</span><span class="s1"> 00000 n </span><span class="se">\n\</span>
<span class="s1">&#39;&#39;&#39;</span></div>

<div class="viewcode-block" id="SignedData.makepdf"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.SignedData.makepdf">[documenti]</a>    <span class="k">def</span> <span class="nf">makepdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdfdata1</span><span class="p">,</span> <span class="n">udct</span><span class="p">,</span> <span class="n">zeros</span><span class="p">,</span> <span class="n">sig_attributes</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">PDFParser</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">pdfdata1</span><span class="p">))</span>
        <span class="n">document</span> <span class="o">=</span> <span class="n">PDFDocument</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get datas from pdf&#39;</span><span class="p">)</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">find_xref</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">xrefs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">trailer</span><span class="p">[</span><span class="s1">&#39;Info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">objid</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">xrefs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">trailer</span><span class="p">[</span><span class="s1">&#39;Root&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">objid</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">xrefs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">trailer</span><span class="p">[</span><span class="s1">&#39;Size&#39;</span><span class="p">]</span>
        <span class="n">page_objid</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;Pages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">objid</span>
        <span class="n">page</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;check sig attributes...&#39;</span><span class="p">)</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">MyConfigLoader</span><span class="p">()</span><span class="o">.</span><span class="n">get_pdf_config</span><span class="p">()[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sig_attributes</span><span class="p">:</span>
            <span class="n">visibility</span> <span class="o">=</span> <span class="n">MyConfigLoader</span><span class="p">()</span><span class="o">.</span><span class="n">get_pdf_config</span><span class="p">()[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">visibility</span> <span class="o">=</span> <span class="n">sig_attributes</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;the sign is </span><span class="si">{visibility}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">visibility</span> <span class="o">==</span> <span class="s1">&#39;visible&#39;</span><span class="p">:</span>
                <span class="n">position</span> <span class="o">=</span> <span class="n">sig_attributes</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;position: </span><span class="si">{position}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">page_pos</span> <span class="o">=</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;page&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">page_pos</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pages_count</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">getobj</span><span class="p">(</span><span class="n">page_objid</span><span class="p">)[</span><span class="s1">&#39;Count&#39;</span><span class="p">]</span>
                <span class="n">page</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">getobj</span><span class="p">(</span><span class="n">page_objid</span><span class="p">)[</span><span class="s1">&#39;Kids&#39;</span><span class="p">][</span><span class="n">pages_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">objid</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">getobj</span><span class="p">(</span><span class="n">page_objid</span><span class="p">)[</span><span class="s1">&#39;Kids&#39;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">page_pos</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">objid</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;page not found...take the first&#39;</span><span class="p">)</span>
                <span class="n">page</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">getobj</span><span class="p">(</span><span class="n">page_objid</span><span class="p">)[</span><span class="s1">&#39;Kids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">objid</span>

        <span class="n">infodata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">pdfdata1</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">document</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">rootdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">pdfdata1</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">document</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">pagedata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">pdfdata1</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">document</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">no</span> <span class="o">=</span> <span class="n">size</span>
        <span class="n">multiple_signs</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">signatures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_signature_names</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">signatures</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">multiple_signs</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">visibility</span> <span class="o">==</span> <span class="s1">&#39;visible&#39;</span><span class="p">:</span>
            <span class="n">rect_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rect_array</span><span class="p">(</span><span class="n">pagedata</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
            <span class="n">stream_name</span> <span class="o">=</span> <span class="n">compress</span><span class="p">(</span><span class="n">STREAM_WITH_NAME</span> <span class="o">%</span> <span class="n">udct</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">multiple_signs</span><span class="p">:</span>
                <span class="n">objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_multi_visible_sig_objs</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">udct</span><span class="p">,</span> <span class="n">no</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">pagedata</span><span class="p">,</span> <span class="n">infodata</span><span class="p">,</span> <span class="n">rootdata</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">,</span> <span class="n">rect_array</span><span class="p">,</span> <span class="n">zeros</span><span class="p">)</span>
                <span class="n">xref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_multi_visible_xref</span><span class="p">()</span>
                <span class="n">new_size</span> <span class="o">=</span> <span class="mi">11</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_visible_sig_objs</span><span class="p">(</span><span class="n">udct</span><span class="p">,</span> <span class="n">no</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">pagedata</span><span class="p">,</span> <span class="n">infodata</span><span class="p">,</span> <span class="n">rootdata</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">,</span> <span class="n">rect_array</span><span class="p">,</span> <span class="n">zeros</span><span class="p">)</span>
                <span class="n">xref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_visible_xref</span><span class="p">()</span>
                <span class="n">new_size</span> <span class="o">=</span> <span class="mi">13</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">multiple_signs</span><span class="p">:</span>
                <span class="n">objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_multi_inv_sig_objs</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">udct</span><span class="p">,</span> <span class="n">no</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">pagedata</span><span class="p">,</span> <span class="n">infodata</span><span class="p">,</span> <span class="n">rootdata</span><span class="p">,</span> <span class="n">zeros</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">signatures</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">xref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_multi_inv_xref</span><span class="p">()</span>
                <span class="n">new_size</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_invisible_sig_objs</span><span class="p">(</span><span class="n">udct</span><span class="p">,</span> <span class="n">no</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">pagedata</span><span class="p">,</span> <span class="n">infodata</span><span class="p">,</span> <span class="n">rootdata</span><span class="p">,</span> <span class="n">zeros</span><span class="p">)</span>
                <span class="n">xref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_multi_inv_xref</span><span class="p">()</span>
                <span class="n">new_size</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="n">pdfdata2</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span>
        <span class="n">startxref</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdfdata1</span><span class="p">)</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">b</span><span class="s1">&#39;page&#39;</span><span class="p">:</span> <span class="n">page</span><span class="p">,</span>
            <span class="sa">b</span><span class="s1">&#39;no&#39;</span><span class="p">:</span> <span class="n">no</span><span class="p">,</span>
            <span class="sa">b</span><span class="s1">&#39;startxref&#39;</span><span class="p">:</span> <span class="n">startxref</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdfdata2</span><span class="p">),</span>
            <span class="sa">b</span><span class="s1">&#39;prev&#39;</span><span class="p">:</span> <span class="n">prev</span><span class="p">,</span>
            <span class="sa">b</span><span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="n">no</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sa">b</span><span class="s1">&#39;root&#39;</span><span class="p">:</span> <span class="n">no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="sa">b</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">no</span> <span class="o">+</span> <span class="n">new_size</span><span class="p">,</span>
            <span class="sa">b</span><span class="s1">&#39;p0&#39;</span><span class="p">:</span> <span class="n">startxref</span> <span class="o">+</span> <span class="n">pdfdata2</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">%d</span><span class="s1"> 0 obj</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="sa">b</span><span class="s1">&#39;h1&#39;</span><span class="p">:</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">pdfdata1</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span>
            <span class="sa">b</span><span class="s1">&#39;h2&#39;</span><span class="p">:</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">pdfdata2</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">new_size</span><span class="p">):</span>
            <span class="n">dct</span><span class="o">.</span><span class="n">update</span><span class="p">(({</span><span class="sa">b</span><span class="s1">&#39;n</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">:</span> <span class="n">startxref</span> <span class="o">+</span> <span class="n">pdfdata2</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">%d</span><span class="s1"> 0 obj</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">}))</span>

        <span class="n">trailer</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s1">trailer</span>
<span class="s1">&lt;&lt;/ID [&lt;</span><span class="si">%(h1)s</span><span class="s1">&gt;&lt;</span><span class="si">%(h2)s</span><span class="s1">&gt;]/Info </span><span class="si">%(info)d</span><span class="s1"> 0 R/Prev </span><span class="si">%(prev)d</span><span class="s1">/Root </span><span class="si">%(root)d</span><span class="s1"> 0 R/Size </span><span class="si">%(size)d</span><span class="s1">&gt;&gt;</span><span class="se">\n\</span>
<span class="s1">startxref</span><span class="se">\n\</span>
<span class="si">%(startxref)d</span><span class="se">\n\</span>
<span class="si">%%%%</span><span class="s1">EOF</span><span class="se">\n\</span>
<span class="s1">&#39;&#39;&#39;</span>

        <span class="n">xref</span> <span class="o">=</span> <span class="n">xref</span> <span class="o">%</span> <span class="n">dct</span>
        <span class="n">trailer</span> <span class="o">=</span> <span class="n">trailer</span> <span class="o">%</span> <span class="n">dct</span>

        <span class="n">pdfdata2</span> <span class="o">=</span> <span class="n">pdfdata2</span> <span class="o">+</span> <span class="n">xref</span> <span class="o">+</span> <span class="n">trailer</span>

        <span class="k">return</span> <span class="n">pdfdata2</span></div>

<div class="viewcode-block" id="SignedData.sign"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.SignedData.sign">[documenti]</a>    <span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datau</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">cert</span><span class="p">,</span> <span class="n">cert_value</span><span class="p">,</span> <span class="n">algomd</span><span class="p">,</span> <span class="n">sig_attributes</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get certificate in format x509 to build signer attributes&#39;</span><span class="p">)</span>
        <span class="n">x509</span> <span class="o">=</span> <span class="n">Certificate</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cert_value</span><span class="p">)</span>

        <span class="n">sign_name</span> <span class="o">=</span> <span class="n">sig_attributes</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="s1">&#39;signature_name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sign_name</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">sign_name</span> <span class="o">=</span> <span class="n">MyConfigLoader</span><span class="p">()</span><span class="o">.</span><span class="n">get_pdf_config</span><span class="p">()[</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="s1">&#39;signatureName&#39;</span><span class="p">]</span>

        <span class="n">dct</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">b</span><span class="s1">&#39;sigflags&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="sa">b</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;%b&#39;</span> <span class="o">%</span> <span class="n">x509</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">native</span><span class="p">[</span><span class="s1">&#39;common_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
            <span class="sa">b</span><span class="s1">&#39;signingdate&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;%b&#39;</span> <span class="o">%</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
            <span class="sa">b</span><span class="s1">&#39;sign_name&#39;</span><span class="p">:</span> <span class="n">sign_name</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="n">zeros</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aligned</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;start building the new pdf&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pdfdata2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makepdf</span><span class="p">(</span><span class="n">datau</span><span class="p">,</span> <span class="n">dct</span><span class="p">,</span> <span class="n">zeros</span><span class="p">,</span> <span class="n">sig_attributes</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;pdf generated correctly&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PDFCreationError</span><span class="p">(</span><span class="s1">&#39;Exception on creating pdf&#39;</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;preparing data to be signed&#39;</span><span class="p">)</span>
        <span class="n">startxref</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">datau</span><span class="p">)</span>
        <span class="n">pdfbr1</span> <span class="o">=</span> <span class="n">pdfdata2</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">zeros</span><span class="p">)</span>
        <span class="n">pdfbr2</span> <span class="o">=</span> <span class="n">pdfbr1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">zeros</span><span class="p">)</span>
        <span class="n">br</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">startxref</span> <span class="o">+</span> <span class="n">pdfbr1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">startxref</span> <span class="o">+</span> <span class="n">pdfbr2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdfdata2</span><span class="p">)</span> <span class="o">-</span> <span class="n">pdfbr2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">brfrom</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;[0000000000 0000000000 0000000000 0000000000]&#39;</span>
        <span class="n">brto</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;[</span><span class="si">%010d</span><span class="s1"> </span><span class="si">%010d</span><span class="s1"> </span><span class="si">%010d</span><span class="s1"> </span><span class="si">%010d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">br</span><span class="p">)</span>
        <span class="n">pdfdata2</span> <span class="o">=</span> <span class="n">pdfdata2</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">brfrom</span><span class="p">,</span> <span class="n">brto</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">b1</span> <span class="o">=</span> <span class="n">pdfdata2</span><span class="p">[:</span><span class="n">br</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">startxref</span><span class="p">]</span>
        <span class="n">b2</span> <span class="o">=</span> <span class="n">pdfdata2</span><span class="p">[</span><span class="n">br</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">startxref</span><span class="p">:]</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">digestSession</span><span class="p">(</span><span class="n">Mechanism</span><span class="p">(</span><span class="n">LowLevel</span><span class="o">.</span><span class="n">CKM_SHA256</span><span class="p">))</span>
        <span class="n">md</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">datau</span><span class="p">)</span>
        <span class="n">md</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span>
        <span class="n">md</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">b2</span><span class="p">)</span>
        <span class="n">md</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">final</span><span class="p">())</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;start pdf signing&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">pdf_signer</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">cert</span><span class="p">,</span> <span class="n">cert_value</span><span class="p">,</span> <span class="n">algomd</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">md</span><span class="p">)</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aligned</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
            <span class="n">pdfdata2</span> <span class="o">=</span> <span class="n">pdfdata2</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">zeros</span><span class="p">,</span> <span class="n">contents</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;pdf signed&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PDFSigningError</span><span class="p">(</span><span class="s1">&#39;error in the sign procedure&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pdfdata2</span></div></div>


<div class="viewcode-block" id="sign"><a class="viewcode-back" href="../../digital_signature.html#digital_signature.pdf_builder.sign">[documenti]</a><span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="n">datau</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">cert</span><span class="p">,</span> <span class="n">cert_value</span><span class="p">,</span> <span class="n">algomd</span><span class="p">,</span> <span class="n">sig_attributes</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="n">SignedData</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">datau</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">cert</span><span class="p">,</span> <span class="n">cert_value</span><span class="p">,</span> <span class="n">algomd</span><span class="p">,</span> <span class="n">sig_attributes</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Giuseppe Russo

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>