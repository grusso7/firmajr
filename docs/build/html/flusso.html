

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="it" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="it" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Flusso di esecuzione &mdash; FirmaJR 0.0.1 documentazione</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script type="text/javascript" src="_static/translations.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Indice" href="genindex.html" />
    <link rel="search" title="Cerca" href="search.html" />
    <link rel="next" title="Firma P7M" href="firma_p7m.html" />
    <link rel="prev" title="Per iniziare a sviluppare" href="getting_started.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> FirmaJR
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contenuti:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Per iniziare a sviluppare</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Flusso di esecuzione</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#avvio-firma-lato-web-application">Avvio firma lato web application</a></li>
<li class="toctree-l2"><a class="reference internal" href="#operazioni-preliminari">Operazioni preliminari</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#parsing-url-e-recupero-parametri">Parsing URL e recupero parametri</a></li>
<li class="toctree-l3"><a class="reference internal" href="#controllo-degli-aggiornamenti">Controllo degli aggiornamenti</a></li>
<li class="toctree-l3"><a class="reference internal" href="#controllo-del-certificato">Controllo del certificato</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#processo-di-firma-dei-file">Processo di firma dei file</a><ul>
<li class="toctree-l3"><a class="reference internal" href="firma_p7m.html">Firma P7M</a></li>
<li class="toctree-l3"><a class="reference internal" href="firma_pdf.html">Firma PDF</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#debug">Debug</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="digital_signature.html">Documentazione API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">FirmaJR</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Flusso di esecuzione</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/flusso.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="flusso-di-esecuzione">
<h1>Flusso di esecuzione<a class="headerlink" href="#flusso-di-esecuzione" title="Link a questa intestazione">¶</a></h1>
<p>In questa sezione sono presenti tutti i passaggi che fanno parte del processo di firma, dalla richiesta che parte da una web application alla
effettiva procedura di firma, differenziando i casi di firma P7M e PDF.
Analizzeremo soprattutto come viene utilizzata nella suite Babel dove tutta la gestione del processo di firma viene fatta nella videata
<strong>Firma Digitale Due</strong> che si trova in <em>Funzioni Pubbliche</em> nel progetto <em>Components</em>.</p>
<div class="section" id="avvio-firma-lato-web-application">
<h2>Avvio firma lato web application<a class="headerlink" href="#avvio-firma-lato-web-application" title="Link a questa intestazione">¶</a></h2>
<p>Per far partire la procedura di firma l’applicazione web dal quale viene effettuata la richiesta deve svolgere dei passaggi preliminari.
In questa fase viene creato il json &lt;signConfiguration&gt; che contiene tutti i parametri e la lista dei file da firmare.
In Babel il metodo si chiama <strong>generateFirmaDueJSON</strong> e si trova nella classe <strong>SignFiles</strong>.
La struttura è la seguente:</p>
<div class="highlight-JSON notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;codice_fiscale&quot;</span><span class="p">,</span>
  <span class="nt">&quot;masterDocumentId&quot;</span><span class="p">:</span> <span class="s2">&quot;masterDocumentId&quot;</span><span class="p">,</span>
  <span class="nt">&quot;file_list&quot;</span><span class="p">:</span> <span class="p">[</span>
  <span class="p">{</span>
  <span class="nt">&quot;file&quot;</span><span class="p">:</span> <span class="s2">&quot;file_path&quot;</span><span class="p">,</span>
  <span class="nt">&quot;file_id&quot;</span><span class="p">:</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span>
  <span class="nt">&quot;file_mime_type&quot;</span><span class="p">:</span> <span class="s2">&quot;file_mime_type&quot;</span><span class="p">,</span>
  <span class="nt">&quot;file_name&quot;</span><span class="p">:</span> <span class="s2">&quot;file_name&quot;</span><span class="p">,</span>
  <span class="nt">&quot;file_type&quot;</span><span class="p">:</span> <span class="s2">&quot;file_type (Es. DocumentoPicoNuovoPU)&quot;</span><span class="p">,</span>
  <span class="nt">&quot;file_data&quot;</span><span class="p">:</span> <span class="s2">&quot;{file additional data (only a bag)}&quot;</span><span class="p">,</span>
  <span class="nt">&quot;signed_file_type&quot;</span><span class="p">:</span> <span class="s2">&quot;p7m|pdf&quot;</span><span class="p">,</span>
  <span class="nt">&quot;destination&quot;</span><span class="p">:</span> <span class="s2">&quot;destination_path&quot;</span><span class="p">,</span>
  <span class="nt">&quot;sig_attributes&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;visibility&quot;</span><span class="p">:</span> <span class="s2">&quot;visibility&quot;</span><span class="p">,</span>
    <span class="nt">&quot;position&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;page&quot;</span><span class="p">:</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span>
      <span class="nt">&quot;width&quot;</span><span class="p">:</span> <span class="s2">&quot;200.0&quot;</span><span class="p">,</span>
      <span class="nt">&quot;height&quot;</span><span class="p">:</span> <span class="s2">&quot;60.0&quot;</span><span class="p">,</span>
      <span class="nt">&quot;padding_width&quot;</span><span class="p">:</span> <span class="s2">&quot;75.0&quot;</span><span class="p">,</span>
      <span class="nt">&quot;padding_height&quot;</span><span class="p">:</span> <span class="s2">&quot;670.0&quot;</span><span class="p">,</span>
      <span class="nt">&quot;signature_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Signature&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;p7m_sig_type&quot;</span><span class="p">:</span> <span class="s2">&quot;p7m_sig_type&quot;</span><span class="p">,</span>
    <span class="nt">&quot;text_template&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}],</span>
  <span class="nt">&quot;test_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;true|false&quot;</span><span class="p">,</span>
  <span class="nt">&quot;update_checker_url&quot;</span><span class="p">:</span> <span class="s2">&quot;[optional]&quot;</span><span class="p">,</span>
  <span class="nt">&quot;revocation_checker_url&quot;</span><span class="p">:</span> <span class="s2">&quot;[optional]&quot;</span><span class="p">,</span>
  <span class="nt">&quot;uploader&quot;</span><span class="p">:</span> <span class="s2">&quot;http://localhost:8095/&quot;</span><span class="p">,</span>
  <span class="nt">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;azienda&quot;</span><span class="p">:</span> <span class="s2">&quot;codice_azienda&quot;</span><span class="p">,</span>
    <span class="nt">&quot;serverIdentifier&quot;</span><span class="p">:</span> <span class="s2">&quot;serverIdentifier&quot;</span><span class="p">,</span>
    <span class="nt">&quot;resultChannel&quot;</span><span class="p">:</span> <span class="s2">&quot;resultChannel&quot;</span><span class="p">,</span>
    <span class="nt">&quot;endSignManagerUrl&quot;</span><span class="p">:</span> <span class="s2">&quot;servlet di fine firma&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Il json viene salvato sul server redis dell’ambiente (Bologna ad esempio) ed associato ad una chiave che chiamamo token. Questa è una delle possibili
soluzioni, come da premessa questo è il metodo usato in Babel, è possibile personalizzare questa soluzione in altri modi.
Dopo questi passaggi viene chiamato un URL con una funzione javascript e l’applicazione web resta in attesa finché non viene conclusa l’operazione di
firma oppure scade il timeout.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">downloadAndNotify</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="nx">name</span><span class="p">,</span><span class="nx">command</span><span class="p">,</span><span class="nx">token</span><span class="p">,</span><span class="nx">close</span><span class="o">=</span><span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">close</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">myWindow</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="nx">name</span><span class="p">);</span>
      <span class="nx">myWindow</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">cmd</span> <span class="o">=</span> <span class="nx">command</span> <span class="o">+</span> <span class="s1">&#39;&amp;params=&#39;</span><span class="o">+</span><span class="nx">token</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">IDEvent</span><span class="p">(</span><span class="s2">&quot;cmd&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">RD3_Glb</span><span class="p">.</span><span class="nx">EVENT_ACTIVE</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>L’URL chiamato è un protocollo che è stato inserito durante l’installazione di FirmaJR ed ha la seguente struttura:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>firmajr://&lt;token&gt;;&lt;url_redis_server&gt;
</pre></div>
</div>
<p>Il &lt;token&gt; è la chiave per identificare e recuperare sul server di redis il json, mentre &lt;url_redis_server&gt; è l’url codificato in base64 del server.</p>
<p>L’apertura di questo URL lancierà applicazione FirmaJR sul PC dell’utente, con alcune differenze se viene aperto da Chrome o Firefox. Su Chrome
viene visualizzato un popoup con la richiesta di confermare o annullare l’apertura dell’applicazione mentre su Firefox viene mostrata una finestra
la quale anch’essa chiede di confermare l’apertura dell’applicazione però con la possibilità di salvare la scelta così che nelle successive richieste
viene eseguita direttamente.</p>
</div>
<div class="section" id="operazioni-preliminari">
<h2>Operazioni preliminari<a class="headerlink" href="#operazioni-preliminari" title="Link a questa intestazione">¶</a></h2>
<p>L’applicazione è in esecuzione, viene letto l’URL aperto dal browser e viene passato al metodo <strong>handle_sign(start_params)</strong> che gestisce le fasi
principali del processo di esecuzione di FirmaJR.
Prima della firma dei file vengono effettuate delle operazioni preliminari:</p>
<ol class="arabic simple">
<li><p>Parsing dell’URL e recupero json con i parametri per la firma</p></li>
<li><p>Controllo degli aggiornamenti</p></li>
<li><p>Controllo del certificato</p></li>
</ol>
<div class="section" id="parsing-url-e-recupero-parametri">
<h3>Parsing URL e recupero parametri<a class="headerlink" href="#parsing-url-e-recupero-parametri" title="Link a questa intestazione">¶</a></h3>
<p>Nella prima fase sono previsti due casi:</p>
<ol class="arabic simple">
<li><p>Nel primo caso viene fatto il parsing dell’URL recuperando i due parametri attesi ovvero il token per identificare univocamente
il json dei parametri e l’url del server di redis dove viene fatta una chiamata HTTP passando come parametro il token.
La risposta della chiamata sarà il json dei parametri visto precedentemente.</p></li>
<li><p>Nel secondo caso invece si presenta quando l’applicazione si avvia in seguito ad un aggiornamento. I parametri non saranno presenti
più nell’URL ma sono stati salvati sul file system, vedremo la procedura in seguito, quindi vengono recuperati nel metodo <strong>get_sign_resume()</strong>.</p></li>
</ol>
</div>
<div class="section" id="controllo-degli-aggiornamenti">
<h3>Controllo degli aggiornamenti<a class="headerlink" href="#controllo-degli-aggiornamenti" title="Link a questa intestazione">¶</a></h3>
<p>Nella seconda fase c’è il controllo degli aggiornamenti <a class="footnote-reference brackets" href="#f1" id="id1">1</a> in FirmaJR viene fatto ogni volta che viene eseguita un’operazione di firma chiamando la funzione
<strong>updates_manager(*parameter_to_save, update_checker_url*)</strong>.</p>
<p>Url del server di aggiornamento è personalizzabile, infatti nel json scaricato nella fase 1 nei i parametri è presente il campo
<em>update_checker_url</em> che può essere diverso da quello preconfigurato.</p>
<p>L’Url è passato al metodo <strong>updates_manager(*parameter_to_save, update_checker_url*)</strong> insieme all’URL completo aperto dal browser
(<em>firmajr://&lt;token&gt;;&lt;url&gt;</em>).
Il metodo gestisce tutta la procedura; effettua il controllo della presenza di nuovi aggiornamenti, se presenti salva i parametri necessari
al recupero dell’operazione di firma in quanto per aggiornarsi è necessario che l’applicazione venga riavviata, infine avvia l’aggiornamento.</p>
<ul class="simple">
<li><p>Il controllo degli aggiornamenti viene effettuato dal metodo <strong>check_for_updates(*update_checker_url*)</strong> al quale viene passato
l’url del server dove fare il controllo. Tale parametro come abbiamo visto è opzionale, se non viene passato viene utilizzato il default presente
nel file di configurazione client_config.</p></li>
<li><p>Se viene trovato un nuovo aggiornamento, l’URL di apertura dell’applicazione completo (<em>firmajr://&lt;token&gt;;&lt;url_encoded&gt;</em>) viene salvato sul
file system nel file <em>sign_status.dat</em> nella directory <em>uploads</em> della home di FirmaJR. Viene salvato in questa cartella per comodità in quanto
viene svuotata alla fine di ogni firma.
Infine il metodo <strong>run_updates(app_update)</strong> effettua il download e l’estrazione dell’aggiornamento e riavvia l’applicazione.</p></li>
<li><p>Dopo il riavvio vengono eseguiti gli stessi passi, se non vengono trovati nuovi aggiornamenti l’esecuzione prosegue allo step successivo.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">updates_manager</span><span class="p">(</span><span class="n">parameter_to_save</span><span class="p">,</span> <span class="n">update_checker_url</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;Gestione degli aggiornamenti. Effettua il controllo di nuovi aggiornamenti ed in tal caso salva i parametri della firma e</span>
<span class="sd">   avvia l&#39;aggiornamento dell&#39;applicazione.</span>

<span class="sd">   :param parameter_to_save: I parameteri da salvare. È l&#39;URL completo con il quale viene lanciata l&#39;applicazione.</span>
<span class="sd">   :type parameter_to_save: str</span>
<span class="sd">   :param update_checker_url: L&#39;url del server dove sono presenti le nuove versioni dell&#39;applicazione</span>
<span class="sd">   :type update_checker_url: str</span>
<span class="sd">   :return: Lo status dell&#39;aggiornamento</span>
<span class="sd">   :rtype: UpdateStatus</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking for client updates.. &quot;</span> <span class="o">+</span> <span class="n">update_checker_url</span><span class="p">)</span>
   <span class="n">app_update</span> <span class="o">=</span> <span class="n">check_for_updates</span><span class="p">(</span><span class="n">update_checker_url</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">app_update</span><span class="p">:</span>
       <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;new update found!&quot;</span><span class="p">)</span>
       <span class="n">save_sign_status</span><span class="p">(</span><span class="n">parameter_to_save</span><span class="p">)</span>
       <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;sign status saved. Start updating...&quot;</span><span class="p">)</span>
       <span class="k">return</span> <span class="n">run_updates</span><span class="p">(</span><span class="n">app_update</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">UPDATE_STATUS_STR</span><span class="p">[</span><span class="n">UpdateStatus</span><span class="o">.</span><span class="n">NO_AVAILABLE_UPDATES</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">check_for_updates</span><span class="p">(</span><span class="n">update_checker_url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
 <span class="sd">&quot;&quot;&quot;Controllo nuovi aggiornamenti.</span>

<span class="sd"> :param update_checker_url: Url server degli aggiornamenti, defaults to None</span>
<span class="sd"> :type update_checker_url: str, optional</span>
<span class="sd"> :return: UpdateObject utilizzato per aggiornare i binari</span>
<span class="sd"> :rtype: AppUpdate</span>
<span class="sd"> &quot;&quot;&quot;</span>
 <span class="k">assert</span> <span class="n">CLIENT_CONFIG</span><span class="o">.</span><span class="n">PUBLIC_KEY</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

 <span class="c1"># Se update_checker_url è presente nel json, allora il controllo degli aggiornamenti viene</span>
 <span class="c1"># fatto su quell&#39;URL altrimenti prendo il default dal file di configurazione</span>
 <span class="k">if</span> <span class="n">update_checker_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
     <span class="n">CLIENT_CONFIG</span><span class="o">.</span><span class="n">UPDATE_URLS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">update_checker_url</span> <span class="o">+</span> <span class="s2">&quot;deploy/&quot;</span>
 <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">CLIENT_CONFIG</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">progress_hooks</span><span class="o">=</span><span class="p">[</span><span class="n">progress</span><span class="p">])</span>
 <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Actual client version: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">digital_signature</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
 <span class="n">appUpdate</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">update_check</span><span class="p">(</span><span class="n">CLIENT_CONFIG</span><span class="o">.</span><span class="n">APP_NAME</span><span class="p">,</span>
                                 <span class="n">digital_signature</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span>
                                 <span class="n">channel</span><span class="o">=</span><span class="s1">&#39;stable&#39;</span><span class="p">)</span>
 <span class="k">return</span> <span class="n">appUpdate</span>

<span class="k">def</span> <span class="nf">save_sign_status</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
 <span class="sd">&quot;&quot;&quot;Salva i parametri sul file system</span>

<span class="sd"> :param params: Parametri iniziali passati all&#39;avvio dell&#39;applicazione nell&#39;URL</span>
<span class="sd"> :type params: str</span>
<span class="sd"> &quot;&quot;&quot;</span>
 <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;saving signature status...&quot;</span><span class="p">)</span>
 <span class="k">try</span><span class="p">:</span>
     <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">UPLOAD_FOLDER</span><span class="p">,</span> <span class="s1">&#39;sign_status.dat&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
         <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
 <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
     <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ex</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">error_response</span><span class="p">(</span><span class="n">SignStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;Errore durante il salvataggio dei parametri per l&#39;aggiornamento&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">run_updates</span><span class="p">(</span><span class="n">app_update</span><span class="p">):</span>
 <span class="sd">&quot;&quot;&quot;Lancia il download dell&#39;aggiornamento e al completamento estrae il file dal zip e riavvia l&#39;applicazione</span>

<span class="sd"> :param app_update: UpdateObject utilizzato per aggiornare i binari</span>
<span class="sd"> :type app_update: AppUpdate</span>
<span class="sd"> :return: Lo stato dell&#39;aggiornamento</span>
<span class="sd"> :rtype: UpdateStatus</span>
<span class="sd"> &quot;&quot;&quot;</span>
 <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Extracting update and restart...&#39;</span><span class="p">)</span>
 <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s2">&quot;frozen&quot;</span><span class="p">):</span>
     <span class="n">downloaded</span> <span class="o">=</span> <span class="n">app_update</span><span class="o">.</span><span class="n">download</span><span class="p">()</span>
     <span class="k">if</span> <span class="n">downloaded</span><span class="p">:</span>
         <span class="n">status</span> <span class="o">=</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">EXTRACTING_UPDATE_AND_RESTARTING</span>
         <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Extracting update and restart...&#39;</span><span class="p">)</span>
         <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
         <span class="n">app_update</span><span class="o">.</span><span class="n">extract_restart</span><span class="p">()</span>
     <span class="k">else</span><span class="p">:</span>
         <span class="n">status</span> <span class="o">=</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">UPDATE_DOWNLOAD_FAILED</span>
 <span class="k">else</span><span class="p">:</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">UpdateStatus</span><span class="o">.</span><span class="n">UPDATE_AVAILABLE_BUT_APP_NOT_FROZEN</span>
 <span class="k">return</span> <span class="n">UPDATE_STATUS_STR</span><span class="p">[</span><span class="n">status</span><span class="p">]</span>
</pre></div>
</div>
<dl class="footnote brackets">
<dt class="label" id="f1"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>Il progetto è configurato attraverso lo script della libreria PyUpdater, il quale genera un file di configurazione <em>client_config.py</em>. In questo file vengono
salvati i parametri necessari a gestire l’operazione, come la public key che serve a decriptare il file zip che contiene l’aggiornamento, il nome
dell’applicazione e l’url del server degli aggiornamenti.</p>
</dd>
</dl>
</div>
<div class="section" id="controllo-del-certificato">
<h3>Controllo del certificato<a class="headerlink" href="#controllo-del-certificato" title="Link a questa intestazione">¶</a></h3>
<p>Nella terza fase del ciclo di esecuzione inizia la preparazione per la firma dei file gestito nel metodo <strong>sign(json_parsed)</strong>.
Vengono effettuati una serie di controlli per la presenza dei parametri nel json che contiene le informazioni necessarie alla firma e i file da firmare.
Anche in questa fase ci sono alcuni step fondamentali che analizziamo.</p>
<ol class="arabic">
<li><p>Reperimento di alcuni parametri dal json della richiesta per salvarli in variabili;</p></li>
<li><p>Aprire la sessione con la smartcard, fatto nel metodo <strong>fetch_smart_card_sessions()</strong> nel file <em>signature_util.py</em>.
In questa funzione vengono caricati i driver di bit4id presenti nella cartella <em>..AppDataRoamingFirmaJRdrivers</em> e viene
stabilita la comunicazione con la smartcard. Viene poi richiesto il pin nel metodo <strong>get_pin(user_id)</strong> dove user_id è il codice fiscale
dell’utente preso dai parametri del json della richiesta.
Il pin viene memorizzato nella variabile <em>user_session</em> e utilizzato per effettuare il login alla sessione della smartcard.
Se il pin non è corretto il login fallisce e viene mostrato all’utente il messaggio di pin errato. È possibile riprovare o annullare.
Se il pin viene sbagliato 3 volte la smartcard si blocca.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
  <span class="n">sessions</span> <span class="o">=</span> <span class="n">DigiSignLib</span><span class="p">()</span><span class="o">.</span><span class="n">get_smart_cards_sessions</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
  <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
  <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{i}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">extract_tb</span><span class="p">(</span><span class="n">tb</span><span class="p">)))</span>
  <span class="n">clear_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">error_response</span><span class="p">(</span><span class="n">SignStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;Controllare che la smart card sia inserita correttamente&quot;</span><span class="p">)</span>

<span class="c1"># attempt to login</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">get_pin</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user_session</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="s2">&quot;pin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;pin not valid&quot;</span><span class="p">)</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">DigiSignLib</span><span class="p">()</span><span class="o">.</span><span class="n">session_login</span><span class="p">(</span><span class="n">sessions</span><span class="p">,</span> <span class="n">user_session</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="s2">&quot;pin&quot;</span><span class="p">])</span>
    <span class="k">break</span>
  <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{i}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">extract_tb</span><span class="p">(</span><span class="n">tb</span><span class="p">)))</span>
    <span class="n">clear_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;aborted&#39;</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">error_response</span><span class="p">(</span><span class="n">SignStatus</span><span class="o">.</span><span class="n">ABORTED</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;Operazione annullata&quot;</span><span class="p">)</span>
    <span class="n">show_warning_message</span><span class="p">(</span><span class="s2">&quot;Controllare che il pin sia valido e corretto&quot;</span><span class="p">)</span>

<span class="c1"># fetching certificate value</span>
<span class="k">try</span><span class="p">:</span>
  <span class="n">certificate</span> <span class="o">=</span> <span class="n">DigiSignLib</span><span class="p">()</span><span class="o">.</span><span class="n">get_certificate</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
  <span class="n">certificate_value</span> <span class="o">=</span> <span class="n">DigiSignLib</span><span class="p">()</span><span class="o">.</span><span class="n">get_certificate_value</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">certificate</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
  <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
  <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{i}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">extract_tb</span><span class="p">(</span><span class="n">tb</span><span class="p">)))</span>
  <span class="n">clear_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">error_response</span><span class="p">(</span><span class="n">SignStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;Impossibile ottenere il certificato di firma&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Effettuato correttamente il login, viene preso dalla smartcard il certificato e salvato in una variabile attraverso il metodo
<strong>get_certificate_value(session, certificate)</strong> presente nella classe DigiSignLib nel file <em>digiSign_lib.py</em>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">get_certificate_value</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">certificate</span><span class="p">):</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Return the value of `certificate`</span>
<span class="sd">Params:</span>
<span class="sd">    session: smart card session</span>
<span class="sd">    certificate: smart card certificate</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;fetching certificate value&quot;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
  <span class="n">certificate_value</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">getAttributeValue</span><span class="p">(</span><span class="n">certificate</span><span class="p">,</span> <span class="p">[</span><span class="n">LowLevel</span><span class="o">.</span><span class="n">CKA_VALUE</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">SmartCardConnectionError</span><span class="p">(</span><span class="s2">&quot;Certificate has no valid value&quot;</span><span class="p">)</span>

<span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">certificate_value</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Caricato il certificato, viene fatto il controllo dello stato di revoca e validità. La procedura è gestita dal metodo
<strong>get_certificate_status(revocation_checker_url, user_id, certificate_value, params)</strong> che effettua una chiamata al <em>revocation checker server</em>
utilizzando l’url preso dai parametri.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_certificate_status</span><span class="p">(</span><span class="n">revocation_checker_url</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">certificate_value</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="sd">&quot;&quot;&quot;Controllo la validità e lo stato di revoca del certificato e salva il risultato nella sessione dell&#39;utente</span>

<span class="sd">:param revocation_checker_url: Url del revocation checker server che effettua il controllo</span>
<span class="sd">:type revocation_checker_url: str</span>
<span class="sd">:param user_id: Il codice fiscale dell&#39;utente</span>
<span class="sd">:type user_id: str</span>
<span class="sd">:param certificate_value: Il certificato da controllare</span>
<span class="sd">:type certificate_value: bytes</span>
<span class="sd">:param params: Parametri personalizzabili, ed esempio nel sistema babel contengono il codice azienda</span>
<span class="sd">:type params: str</span>
<span class="sd">:return: Il json con il risultato del controllo contenente: status, behaviours, timestamp, check codice fiscale</span>
<span class="sd">:rtype: json</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">check_resp</span> <span class="o">=</span> <span class="n">RevocationChecker</span><span class="p">()</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">revocation_checker_url</span><span class="p">,</span> <span class="n">certificate_value</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
<span class="n">cert_status</span> <span class="o">=</span> <span class="n">check_resp</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span>
<span class="k">if</span> <span class="n">cert_status</span> <span class="o">==</span> <span class="n">ERROR</span><span class="p">:</span>
    <span class="c1"># set cert_status to UNKNOWN to continue execution</span>
    <span class="c1"># log already done by RevocationChecker</span>
    <span class="n">cert_status</span> <span class="o">=</span> <span class="n">UNKNOWN</span>
<span class="n">user_session</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cert_status</span>

<span class="n">status</span> <span class="o">=</span> <span class="n">user_session</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Certificate status: </span><span class="si">{status}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">return</span> <span class="n">check_resp</span>
</pre></div>
</div>
<p>La risposta del server ha la seguente struttura:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;status&quot;</span><span class="p">,</span>         <span class="c1"># Stato di validità del certificato, scaduto, valido o invalido</span>
  <span class="s2">&quot;behaviours&quot;</span><span class="p">:</span> <span class="s2">&quot;behaviours&quot;</span><span class="p">,</span> <span class="c1"># Contiene l&#39;informazione di come l&#39;applicazione deve comportarsi nei casi in cui il certificato non è regolare</span>
  <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span>   <span class="c1"># Data e ora della firma</span>
  <span class="s2">&quot;check_cf&quot;</span><span class="p">:</span> <span class="s2">&quot;check_cf&quot;</span><span class="p">,</span>     <span class="c1"># Controllo del codice fiscale dell&#39;utente loggato con quello del certificato</span>
  <span class="s2">&quot;check_certificate&quot;</span><span class="p">:</span> <span class="s2">&quot;check_certificate&quot;</span> <span class="c1"># Controllo se il certificato è stato revocato</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Se il certificato è stato revocato la procedura si interrompe mostrando un messaggio all’utente.
Se lo stato del certificato è non attendibile, caso in cui il certificato è valido ma non è garantito da una Autorità di Certificazione
inclusa nell’elenco Pubblico dei Certificatori viene fatto un controllo sulla proprietà <em>behaviours</em> per decidere se mostrare un messaggio e
far scegliere all’utente se continuare oppure interrompere l’operazione di firma e chiudere l’applicazione.
Se il certificato è valido e tutti i controlli sono superati si passa alla firma effettiva dei file.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="processo-di-firma-dei-file">
<h2>Processo di firma dei file<a class="headerlink" href="#processo-di-firma-dei-file" title="Link a questa intestazione">¶</a></h2>
<p>La firma digitale avviene all’interno di un loop che cicla sulla lista dei file passati nel json dei parametri.
Per ognuno vengono prese le proprietà dal json per inizializzare: le variabili, l’oggetto che conterrà il risultato e il path del file.
Se quest’ultimo è un URL il file viene scaricato con una chiamata http ad una servlet apposita e salvato nella cartella <em>uploads</em> nella home
di FirmaJR memorizzando il path locale in una variabile.</p>
<p>A questo punto, in base alla proprietà <em>signature_type</em> il file viene firmato in <strong>P7M</strong> oppure in <strong>PDF</strong> e la procedura è gestita rispettivamente
dai metodi <strong>sign_p7m(*args*)</strong> e <strong>sign_pdf(*args*)</strong>.</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="firma_p7m.html">Firma P7M</a></li>
</ul>
</div>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="firma_pdf.html">Firma PDF</a></li>
</ul>
</div>
<p>Entrambi i metodi restituiscono il path del file firmato che verrà aggiunto all’oggetto contenitore del risultato che a sua volta viene aggiunto
alla lista dei file firmati <em>signed_files_list</em> che è il dato che viene restituito dalla funzione insieme allo status.
Viene infine costruito il json che verrà inviato tramite una chiamata Http alla servlet di fine firma e l’applicazione terminerà l’esecuzione.</p>
</div>
<div class="section" id="debug">
<h2>Debug<a class="headerlink" href="#debug" title="Link a questa intestazione">¶</a></h2>
<p>Per eseguire in debug un processo di firma basta sostituire nel main, all’interno del file <em>digiSign_server.py</em>, la variabile <em>sys_params</em>
decommentando la riga successiva e sostituendo l’url con quello della firma che deve essere analizzata.
L’url è possibile reperirlo sia dal file di log di FirmaJR che dagli strumenti sviluppatore del browser utilizzato.</p>
<p>Infine lanciare l’applicazione in debug direttamente dall’IDE.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="firma_p7m.html" class="btn btn-neutral float-right" title="Firma P7M" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="getting_started.html" class="btn btn-neutral float-left" title="Per iniziare a sviluppare" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Giuseppe Russo

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>