

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="it" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="it" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Firma PDF &mdash; FirmaJR 0.0.1 documentazione</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script type="text/javascript" src="_static/translations.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Indice" href="genindex.html" />
    <link rel="search" title="Cerca" href="search.html" />
    <link rel="next" title="Documentazione API" href="digital_signature.html" />
    <link rel="prev" title="Firma P7M" href="firma_p7m.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> FirmaJR
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contenuti:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Per iniziare a sviluppare</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="flusso.html">Flusso di esecuzione</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="flusso.html#avvio-firma-lato-web-application">Avvio firma lato web application</a></li>
<li class="toctree-l2"><a class="reference internal" href="flusso.html#operazioni-preliminari">Operazioni preliminari</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="flusso.html#processo-di-firma-dei-file">Processo di firma dei file</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="firma_p7m.html">Firma P7M</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Firma PDF</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="digital_signature.html">Documentazione API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">FirmaJR</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="flusso.html">Flusso di esecuzione</a> &raquo;</li>
        
      <li>Firma PDF</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/firma_pdf.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="firma-pdf">
<h1>Firma PDF<a class="headerlink" href="#firma-pdf" title="Link a questa intestazione">¶</a></h1>
<p>La firma di un file PDF avviene nel metodo <strong>sign_pdf(*args*)</strong> che si trova nel file <em>digiSign_lib.py</em> dei sorgenti.</p>
<p>Anche qui come nella firma p7m viene fatto subito il controllo dell’identità dell’utente, opzionale se è una firma in fase di test.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">sign_pdf</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">open_session</span><span class="p">,</span> <span class="n">certificate</span><span class="p">,</span> <span class="n">certificate_value</span><span class="p">,</span> <span class="n">user_cf</span><span class="p">,</span> <span class="n">sig_attributes</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">check_cf</span><span class="p">):</span>
<span class="sd">&quot;&quot;&quot;Metodo per la gestione della firma del file PDF</span>

<span class="sd">:param file_path: Il path del file da firmare</span>
<span class="sd">:type file_path: str</span>
<span class="sd">:param open_session: La sessione aperta della smartcard</span>
<span class="sd">:type open_session: Object</span>
<span class="sd">:param certificate: Il certificato della smartcard</span>
<span class="sd">:type certificate: Obj</span>
<span class="sd">:param certificate_value: Il valore del certificato</span>
<span class="sd">:type certificate_value: bytes</span>
<span class="sd">:param user_cf: Il codice fiscale dell&#39;utente</span>
<span class="sd">:type user_cf: str</span>
<span class="sd">:param sig_attributes: I parametri della firma</span>
<span class="sd">:type sig_attributes: Obj</span>
<span class="sd">:param timestamp: Timestamp dell&#39;ora di firma</span>
<span class="sd">:type timestamp: timestamp</span>
<span class="sd">:param check_cf: Parametro per fare o no il controllo del codice fiscale</span>
<span class="sd">:type check_cf: bool</span>
<span class="sd">:raises PdfVerificationError: Errore nella verifica del file firmato</span>
<span class="sd">:return: Il path del file firmato in PDF</span>
<span class="sd">:rtype: str</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># check for signer identity</span>
<span class="k">if</span> <span class="n">check_cf</span><span class="p">:</span>
  <span class="n">DigiSignLib</span><span class="p">()</span><span class="o">.</span><span class="n">_check_certificate_owner</span><span class="p">(</span><span class="n">certificate_value</span><span class="p">,</span> <span class="n">user_cf</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
  <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;check for certificate owner skipped&quot;</span><span class="p">)</span>

<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;reading pdf file </span><span class="si">{file_path}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">datau</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">datas</span> <span class="o">=</span> <span class="n">pdf_builder</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">datau</span><span class="p">,</span> <span class="n">open_session</span><span class="p">,</span> <span class="n">certificate</span><span class="p">,</span> <span class="n">certificate_value</span><span class="p">,</span> <span class="s1">&#39;sha256&#39;</span><span class="p">,</span> <span class="n">sig_attributes</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>

<span class="n">signed_file_path</span> <span class="o">=</span> <span class="n">DigiSignLib</span><span class="p">()</span><span class="o">.</span><span class="n">get_signed_files_path</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;pdf&#39;</span><span class="p">)</span>

<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;saving output to </span><span class="si">{signed_file_path}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">signed_file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
  <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">datau</span><span class="p">)</span>
  <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">datas</span><span class="p">)</span>

<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;verifying pdf signatures of </span><span class="si">{signed_file_path}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
  <span class="n">new_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">signed_file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
  <span class="n">results</span> <span class="o">=</span> <span class="n">verify</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="p">[</span><span class="n">certificate_value</span><span class="p">])</span>
  <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Signature </span><span class="si">%d</span><span class="s1">: &#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signature </span><span class="si">{key}</span><span class="s2">: </span><span class="si">{res}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;hashok?&#39;</span><span class="p">]:</span>
      <span class="k">raise</span> <span class="n">PdfVerificationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hash verification of Signature </span><span class="si">{key}</span><span class="s2"> is failed.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;signatureok?&#39;</span><span class="p">]:</span>
      <span class="k">raise</span> <span class="n">PdfVerificationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signature verification of Signature </span><span class="si">{key}</span><span class="s2"> is failed.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;certok?&#39;</span><span class="p">]:</span>
      <span class="c1"># TODO verify certificates</span>
      <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Certificate verification of Signature </span><span class="si">{key}</span><span class="s2"> is failed.&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
  <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during verification of Signature </span><span class="si">{key}</span><span class="s2">:&quot;</span><span class="p">)</span>
  <span class="k">raise</span>

<span class="k">return</span> <span class="n">signed_file_path</span>
</pre></div>
</div>
<p>Il file viene letto in bytes e viene passato al metodo <strong>sign(*agrs*)</strong> della classe <strong>SignedData</strong> nel file <strong>pdf_builder.py</strong> dei sorgenti
insieme alla sessione, il certificato, il valore del certificato, l’algoritmo crittografico, gli attributi di firma e il timestamp dell’ora di firma.
Viene letto attraverso la classe <em>Certificate</em> della libreria <em>asn1crypto</em> il valore del certificato nel formato standard x509 in modo da
poter reperire le informazioni in modo agevole ed estrarre in questo caso il nome dell’utente dal certificato e creare il seguente dict:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dct</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sa">b</span><span class="s1">&#39;sigflags&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="c1"># Valore per il tag SigFlags del pdf, un valore diverso da 0 indica che sul pdf sono presenti delle firme, normalmente viene utilizzato sempre il 3</span>
  <span class="sa">b</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;%b&#39;</span> <span class="o">%</span> <span class="n">x509</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">native</span><span class="p">[</span><span class="s1">&#39;common_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="c1"># Il nome dell&#39;utente</span>
  <span class="sa">b</span><span class="s1">&#39;signingdate&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;%b&#39;</span> <span class="o">%</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>                   <span class="c1"># Timestamp dell&#39;ora di firma</span>
  <span class="sa">b</span><span class="s1">&#39;sign_name&#39;</span><span class="p">:</span> <span class="n">sign_name</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>                              <span class="c1"># Il titolo del campo firma</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Quindi viene passato alla funzione <strong>makepdf(self, pdfdata1, udct, zeros, sig_attributes)</strong>, insieme ai bytes del file da firmare (pdfdata1),
un segnaposto che conterrà il file firmato (zeros) ed infine gli attributi di firma letti dal json iniziale.
Il metodo genera il nuovo file pdf aggiungendo dei tag che conterranno le informazioni della firma.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">makepdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdfdata1</span><span class="p">,</span> <span class="n">udct</span><span class="p">,</span> <span class="n">zeros</span><span class="p">,</span> <span class="n">sig_attributes</span><span class="p">):</span>
  <span class="n">parser</span> <span class="o">=</span> <span class="n">PDFParser</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">pdfdata1</span><span class="p">))</span>
  <span class="n">document</span> <span class="o">=</span> <span class="n">PDFDocument</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get datas from pdf&#39;</span><span class="p">)</span>
  <span class="n">prev</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">find_xref</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
  <span class="n">info</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">xrefs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">trailer</span><span class="p">[</span><span class="s1">&#39;Info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">objid</span>
  <span class="n">root</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">xrefs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">trailer</span><span class="p">[</span><span class="s1">&#39;Root&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">objid</span>
  <span class="n">size</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">xrefs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">trailer</span><span class="p">[</span><span class="s1">&#39;Size&#39;</span><span class="p">]</span>
  <span class="n">page_objid</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;Pages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">objid</span>
  <span class="n">page</span> <span class="o">=</span> <span class="kc">None</span>

  <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;check sig attributes...&#39;</span><span class="p">)</span>
  <span class="n">position</span> <span class="o">=</span> <span class="n">MyConfigLoader</span><span class="p">()</span><span class="o">.</span><span class="n">get_pdf_config</span><span class="p">()[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">sig_attributes</span><span class="p">:</span>
      <span class="n">visibility</span> <span class="o">=</span> <span class="n">MyConfigLoader</span><span class="p">()</span><span class="o">.</span><span class="n">get_pdf_config</span><span class="p">()[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span>
  <span class="k">else</span><span class="p">:</span>
      <span class="n">visibility</span> <span class="o">=</span> <span class="n">sig_attributes</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span>
      <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;the sign is </span><span class="si">{visibility}</span><span class="s1">&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">visibility</span> <span class="o">==</span> <span class="s1">&#39;visible&#39;</span><span class="p">:</span>
          <span class="n">position</span> <span class="o">=</span> <span class="n">sig_attributes</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span>
          <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;position: </span><span class="si">{position}</span><span class="s1">&#39;</span><span class="p">)</span>

  <span class="n">page_pos</span> <span class="o">=</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;page&#39;</span><span class="p">]</span>
  <span class="k">if</span> <span class="n">page_pos</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
          <span class="n">pages_count</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">getobj</span><span class="p">(</span><span class="n">page_objid</span><span class="p">)[</span><span class="s1">&#39;Count&#39;</span><span class="p">]</span>
          <span class="n">page</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">getobj</span><span class="p">(</span><span class="n">page_objid</span><span class="p">)[</span><span class="s1">&#39;Kids&#39;</span><span class="p">][</span><span class="n">pages_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">objid</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
          <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
          <span class="n">page</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">getobj</span><span class="p">(</span><span class="n">page_objid</span><span class="p">)[</span><span class="s1">&#39;Kids&#39;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">page_pos</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">objid</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
          <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;page not found...take the first&#39;</span><span class="p">)</span>
          <span class="n">page</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">getobj</span><span class="p">(</span><span class="n">page_objid</span><span class="p">)[</span><span class="s1">&#39;Kids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">objid</span>

  <span class="n">infodata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">pdfdata1</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">document</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
  <span class="n">rootdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">pdfdata1</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">document</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
  <span class="n">pagedata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">pdfdata1</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">document</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

  <span class="n">no</span> <span class="o">=</span> <span class="n">size</span>
  <span class="n">multiple_signs</span> <span class="o">=</span> <span class="kc">False</span>
  <span class="n">signatures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_signature_names</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">signatures</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">multiple_signs</span> <span class="o">=</span> <span class="kc">True</span>

  <span class="k">if</span> <span class="n">visibility</span> <span class="o">==</span> <span class="s1">&#39;visible&#39;</span><span class="p">:</span>
      <span class="n">rect_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rect_array</span><span class="p">(</span><span class="n">pagedata</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
      <span class="n">stream_name</span> <span class="o">=</span> <span class="n">compress</span><span class="p">(</span><span class="n">STREAM_WITH_NAME</span> <span class="o">%</span> <span class="n">udct</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">multiple_signs</span><span class="p">:</span>
          <span class="n">objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_multi_visible_sig_objs</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">udct</span><span class="p">,</span> <span class="n">no</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">pagedata</span><span class="p">,</span> <span class="n">infodata</span><span class="p">,</span> <span class="n">rootdata</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">,</span> <span class="n">rect_array</span><span class="p">,</span> <span class="n">zeros</span><span class="p">)</span>
          <span class="n">xref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_multi_visible_xref</span><span class="p">()</span>
          <span class="n">new_size</span> <span class="o">=</span> <span class="mi">11</span>
      <span class="k">else</span><span class="p">:</span>
          <span class="n">objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_visible_sig_objs</span><span class="p">(</span><span class="n">udct</span><span class="p">,</span> <span class="n">no</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">pagedata</span><span class="p">,</span> <span class="n">infodata</span><span class="p">,</span> <span class="n">rootdata</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">,</span> <span class="n">rect_array</span><span class="p">,</span> <span class="n">zeros</span><span class="p">)</span>
          <span class="n">xref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_visible_xref</span><span class="p">()</span>
          <span class="n">new_size</span> <span class="o">=</span> <span class="mi">13</span>
  <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">multiple_signs</span><span class="p">:</span>
          <span class="n">objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_multi_inv_sig_objs</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">udct</span><span class="p">,</span> <span class="n">no</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">pagedata</span><span class="p">,</span> <span class="n">infodata</span><span class="p">,</span> <span class="n">rootdata</span><span class="p">,</span> <span class="n">zeros</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">signatures</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
          <span class="n">xref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_multi_inv_xref</span><span class="p">()</span>
          <span class="n">new_size</span> <span class="o">=</span> <span class="mi">5</span>
      <span class="k">else</span><span class="p">:</span>
          <span class="n">objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_invisible_sig_objs</span><span class="p">(</span><span class="n">udct</span><span class="p">,</span> <span class="n">no</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">pagedata</span><span class="p">,</span> <span class="n">infodata</span><span class="p">,</span> <span class="n">rootdata</span><span class="p">,</span> <span class="n">zeros</span><span class="p">)</span>
          <span class="n">xref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_multi_inv_xref</span><span class="p">()</span>
          <span class="n">new_size</span> <span class="o">=</span> <span class="mi">5</span>

  <span class="n">pdfdata2</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span>
  <span class="n">startxref</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdfdata1</span><span class="p">)</span>
  <span class="n">dct</span> <span class="o">=</span> <span class="p">{</span>
      <span class="sa">b</span><span class="s1">&#39;page&#39;</span><span class="p">:</span> <span class="n">page</span><span class="p">,</span>
      <span class="sa">b</span><span class="s1">&#39;no&#39;</span><span class="p">:</span> <span class="n">no</span><span class="p">,</span>
      <span class="sa">b</span><span class="s1">&#39;startxref&#39;</span><span class="p">:</span> <span class="n">startxref</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdfdata2</span><span class="p">),</span>
      <span class="sa">b</span><span class="s1">&#39;prev&#39;</span><span class="p">:</span> <span class="n">prev</span><span class="p">,</span>
      <span class="sa">b</span><span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="n">no</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span>
      <span class="sa">b</span><span class="s1">&#39;root&#39;</span><span class="p">:</span> <span class="n">no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
      <span class="sa">b</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">no</span> <span class="o">+</span> <span class="n">new_size</span><span class="p">,</span>
      <span class="sa">b</span><span class="s1">&#39;p0&#39;</span><span class="p">:</span> <span class="n">startxref</span> <span class="o">+</span> <span class="n">pdfdata2</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">%d</span><span class="s1"> 0 obj</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
      <span class="sa">b</span><span class="s1">&#39;h1&#39;</span><span class="p">:</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">pdfdata1</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span>
      <span class="sa">b</span><span class="s1">&#39;h2&#39;</span><span class="p">:</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">pdfdata2</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">new_size</span><span class="p">):</span>
      <span class="n">dct</span><span class="o">.</span><span class="n">update</span><span class="p">(({</span><span class="sa">b</span><span class="s1">&#39;n</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">:</span> <span class="n">startxref</span> <span class="o">+</span> <span class="n">pdfdata2</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">%d</span><span class="s1"> 0 obj</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">}))</span>

  <span class="n">trailer</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s1">    trailer</span>
<span class="s1">    &lt;&lt;/ID [&lt;</span><span class="si">%(h1)s</span><span class="s1">&gt;&lt;</span><span class="si">%(h2)s</span><span class="s1">&gt;]/Info </span><span class="si">%(info)d</span><span class="s1"> 0 R/Prev </span><span class="si">%(prev)d</span><span class="s1">/Root </span><span class="si">%(root)d</span><span class="s1"> 0 R/Size </span><span class="si">%(size)d</span><span class="s1">&gt;&gt;</span><span class="se">\n\</span>
<span class="s1">    startxref</span><span class="se">\n\</span>
<span class="s1">    </span><span class="si">%(startxref)d</span><span class="se">\n\</span>
<span class="s1">    </span><span class="si">%%%%</span><span class="s1">EOF</span><span class="se">\n\</span>
<span class="s1">    &#39;&#39;&#39;</span>

  <span class="n">xref</span> <span class="o">=</span> <span class="n">xref</span> <span class="o">%</span> <span class="n">dct</span>
  <span class="n">trailer</span> <span class="o">=</span> <span class="n">trailer</span> <span class="o">%</span> <span class="n">dct</span>

  <span class="n">pdfdata2</span> <span class="o">=</span> <span class="n">pdfdata2</span> <span class="o">+</span> <span class="n">xref</span> <span class="o">+</span> <span class="n">trailer</span>

  <span class="k">return</span> <span class="n">pdfdata2</span>
</pre></div>
</div>
<p>Per comprendere meglio cosa avviene descriviamo brevemente com’è strutturato un file pdf.</p>
<p>Un pdf è composto da:</p>
<ul class="simple">
<li><p>Un <em>header</em> che identifica la versione specifica al quale il pdf è conforme</p></li>
<li><p>Un <em>body</em> contenente gli oggetti che sono presenti nel file</p></li>
<li><p>Una <em>cross-reference table</em> contenente le informazioni degli oggetti indiretti del file</p></li>
<li><p>Un <em>trailer</em> che fornisce la posizione della cross-reference table e di speciali oggetti all’interno del file</p></li>
</ul>
<p>La struttura del file può essere modificata da aggiornamenti futuri, che consiste nell’aggiunta di nuovi elementi alla fine del file,
che è quello che avviene in FirmaJR. Vengono aggiunti nuovi oggetti e aggiornati i dati nella cross-reference table.</p>
<p>La costruzione del nuovo pdf avviene in questo modo: viene parsato attraverso una libreria il file pdf da firmare in modo che al posto
dei bytes è possibile «navigare» il file attraverso delle proprietà. Ogni proprietà è definita attraverso un Tag che all’interno del pdf
è un oggetto identificato da una proprietà chiamata <strong>objid</strong>.</p>
<p>Vengono estratti dal trailer tre oggetti che contengono informazioni per creare il nuovo pdf e sono:</p>
<ol class="arabic simple">
<li><p><strong>Info</strong>, è un tag opzionale che contiene i metadata del file</p></li>
<li><p><strong>Root</strong>, tag obbligatorio, è il catalogo dizionario che contiene le referenze degli altri oggetti definiti nel documento</p></li>
<li><p><strong>Size</strong>, tag obbligatorio, è il numero di tutte le voci nella cross-reference table e definito dalla combinazione della sezione originale e tutte le sezioni aggiornate.</p></li>
</ol>
<p>Visivamente la firma di un pdf può essere in due modi:</p>
<ol class="arabic simple">
<li><p>Visibile, viene apposta su una pagina, scelta, l’informazione della firma, eg. Nome e Cognome del firmatario</p></li>
<li><p>Invisibile, sul documento non c’è alcuna informazione visiva e la firma è visibile dal pannello firme</p></li>
</ol>
<p>La visibilità della firma è parametrica e l’informazione è contenuta all’interno dei sig_attributes passati in ingresso.
In base a questo parametro vengono creati nuovi oggetti, ognuno contenente i tag necessari affinché la firma sia considerata valida per
ciascun caso e nello specifico della firma visibile viene individuata la pagina dove inserire il box con il nome e cognome del firmatario.
Ogni oggetto creato avrà un suo objid in modo che potrà essere identificato nella cross-reference table.</p>
<p>Di seguito il codice del metodo che crea un oggetto per una firma visibile:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_visible_sig_objs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">udct</span><span class="p">,</span> <span class="n">no</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">pagedata</span><span class="p">,</span> <span class="n">infodata</span><span class="p">,</span> <span class="n">rootdata</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">,</span> <span class="n">rect</span><span class="p">,</span> <span class="n">zeros</span><span class="p">):</span>
  <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;load font&quot;</span><span class="p">)</span>
  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_PATH</span><span class="p">,</span> <span class="s1">&#39;encoded_font.bin&#39;</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">font_file</span><span class="p">:</span>
      <span class="n">font</span> <span class="o">=</span> <span class="n">font_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;unicode-escape&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">)</span>
  <span class="n">objs</span> <span class="o">=</span> <span class="p">[</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/Annots[</span><span class="si">%d</span><span class="s1"> 0 R]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">pagedata</span><span class="p">),</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">infodata</span><span class="p">),</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/AcroForm&lt;&lt;/SigFlags </span><span class="si">%d</span><span class="s1">/Fields[</span><span class="si">%d</span><span class="s1"> 0 R]/DA(/Helv 0 Tf 0 g)/DR &lt;&lt;/Font&lt;&lt;/ZaDb </span><span class="si">%d</span><span class="s1"> 0 R/Helv </span><span class="si">%d</span><span class="s1"> 0 R&gt;&gt;&gt;&gt;&gt;&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">udct</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;sigflags&#39;</span><span class="p">],</span> <span class="n">no</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">no</span> <span class="o">+</span> <span class="mi">11</span><span class="p">,</span> <span class="n">no</span> <span class="o">+</span> <span class="mi">12</span><span class="p">))</span> <span class="o">+</span> <span class="n">rootdata</span><span class="p">),</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
              <span class="sa">b</span><span class="s1">&#39;/AP&lt;&lt;/N </span><span class="si">%d</span><span class="s1"> 0 R&gt;&gt;/Type/Annot/F 132/DA(/Arial 0 Tf 0 g)/FT/Sig/DR &lt;&lt;&gt;&gt;/P </span><span class="si">%d</span><span class="s1"> 0 R/Rect[</span><span class="si">%.2f</span><span class="s1"> </span><span class="si">%.2f</span><span class="s1"> </span><span class="si">%.2f</span><span class="s1"> </span><span class="si">%.2f</span><span class="s1">]/Subtype/Widget/T(</span><span class="si">%s</span><span class="s1">)/V </span><span class="si">%d</span><span class="s1"> 0 R&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">rect</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rect</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rect</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">udct</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;sign_name&#39;</span><span class="p">],</span> <span class="n">no</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)),</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">makeobj_stream</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Subtype/Form/Filter/FlateDecode/Type/XObject/Matrix [1 0 0 1 0 0]/FormType 1/Resources&lt;&lt;/ProcSet [/PDF /Text /ImageB /ImageC /ImageI]/XObject&lt;&lt;/FRM </span><span class="si">%d</span><span class="s1"> 0 R&gt;&gt;&gt;&gt;/BBox[0 0 200 60]/Length 29&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">5</span><span class="p">),</span> <span class="n">compress</span><span class="p">(</span><span class="n">FRM_STREAM</span><span class="p">)),</span>
      <span class="sa">b</span><span class="s1">&#39;stream</span><span class="se">\n\x78\x9C\x03\x00\x00\x00\x00\x01\n</span><span class="s1">endstream</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
            <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/ByteRange [0000000000 0000000000 0000000000 0000000000]/Name(</span><span class="si">%s</span><span class="s1">)/Filter/Adobe.PPKLite/M(D:</span><span class="si">%s</span><span class="s1">)/SubFilter/ETSI.CAdES.detached/Type/Sig/FT/Sig/Contents &lt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">udct</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">udct</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;signingdate&#39;</span><span class="p">]))</span> <span class="o">+</span> <span class="n">zeros</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;&gt;&#39;</span><span class="p">),</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">makeobj_stream</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Subtype/Form/Filter/FlateDecode/Type/XObject/Matrix [1 0 0 1 0 0]/FormType 1/Resources&lt;&lt;/ProcSet [/PDF /Text /ImageB /ImageC /ImageI]/XObject&lt;&lt;/n0 </span><span class="si">%d</span><span class="s1"> 0 R/n2 </span><span class="si">%d</span><span class="s1"> 0 R&gt;&gt;&gt;&gt;/BBox[0 0 200 60]/Length 34&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="n">no</span> <span class="o">+</span> <span class="mi">7</span><span class="p">),</span> <span class="n">compress</span><span class="p">(</span><span class="n">N0_N2_STREAM</span><span class="p">)),</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">makeobj_stream</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Subtype/Form/Filter/FlateDecode/Type/XObject/Matrix [1 0 0 1 0 0]/FormType 1/Resources&lt;&lt;/ProcSet [/PDF /Text /ImageB /ImageC /ImageI]&gt;&gt;/BBox[0 0 100 100]/Length 18&#39;</span><span class="p">,</span> <span class="n">compress</span><span class="p">(</span><span class="n">DSBLANK_STREAM</span><span class="p">)),</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">makeobj_stream</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Subtype/Form/Filter/FlateDecode/Type/XObject/Matrix [1 0 0 1 0 0]/FormType 1/Resources&lt;&lt;/ProcSet [/PDF /Text /ImageB /ImageC /ImageI]/Font&lt;&lt;/F1 </span><span class="si">%d</span><span class="s1"> 0 R&gt;&gt;&gt;&gt;/BBox[0 0 200 60]/Length </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">stream_name</span><span class="p">)),</span> <span class="n">stream_name</span><span class="p">),</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Subtype/TrueType/FirstChar 32/Type/Font/BaseFont/ArialMT/FontDescriptor </span><span class="si">%d</span><span class="s1"> 0 R/Encoding/WinAnsiEncoding/LastChar 126/Widths[277 277 354 556 556 889 666 190 333 333 389 583 277 333 277 277 556 556 556 556 556 556 556 556 556 556 277 277 583 583 583 556 1015 666 666 722 722 666 610 777 722 277 500 666 556 833 722 777 666 777 722 666 610 722 666 943 666 666 610 277 277 277 469 556 333 556 556 500 556 556 277 556 556 222 222 500 222 833 556 556 556 556 333 500 277 556 500 722 500 500 500 333 259 333 583]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)),</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">9</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Descent -210/CapHeight 716/StemV 80/Type/FontDescriptor/FontFile2 </span><span class="si">%d</span><span class="s1"> 0 R/Flags 32/FontBBox[-664 -324 2000 1039]/FontName/ArialMT/ItalicAngle 0/Ascent 728&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)),</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">makeobj_font_stream</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Length1 96488/Filter/FlateDecode/Length 44982&#39;</span><span class="p">,</span> <span class="n">font</span><span class="p">),</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">11</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Name/ZaDb/Subtype/Type1/Type/Font/BaseFont/ZapfDingbats&#39;</span><span class="p">),</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">makeobj</span><span class="p">(</span><span class="n">no</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/Name/Helv/Subtype/Type1/Type/Font/BaseFont/Helvetica/Encoding/WinAnsiEncoding&#39;</span><span class="p">),</span>
  <span class="p">]</span>
  <span class="k">return</span> <span class="n">objs</span>
</pre></div>
</div>
<p>Ogni oggetto e tag è strettamente necessario per validità della firma.
I più importanti da citare sono gli oggetti che creato i seguenti tag:</p>
<ul class="simple">
<li><p><strong>Acroform</strong>, dove sono definite proprietà del documento come i <strong>SigFlags</strong> che specificano le caratteristiche dei campi della firma, <strong>Fields</strong> un array di riferimenti a oggetti del documento, nel nostro caso il field firma creato successivamente.</p></li>
<li><p>Il field della firma, ha come tag <em>AP</em>, il dizionario dell’Appearance dove vengono definiti i tag visivi, come il nome visualizzato nel pannello firma <strong>/T</strong>, le dimensioni del box che conterranno la firma visibile e su quale pagina sarà inserito che sono rispettivamente <strong>/Rect</strong> e <em>/P</em> ed infine ma i più importanti il tag <strong>/FT</strong>, field type che è di tipo <em>Sig</em> e <strong>/V</strong>, field value che conterrà le informazioni del file firmato.</p></li>
<li><p>Il field value, contiene le informazioni della firma. Il tag <strong>/ByteRange</strong>, che conterrà il range dei bytes della firma all’interno dell’intero documento e il più importante <strong>/Contents</strong> che conterrà i bytes del file firmato.</p></li>
</ul>
<p>Per avere una descrizione dettagliata di tutti i tag, si rimanda alla documentazione ufficiale del pdf. <a class="reference external" href="https://www.adobe.com/content/dam/acom/en/devnet/pdf/pdf_reference_archive/pdf_reference_1-7.pdf">PDF Reference</a></p>
<p>Viene infine ricostruita la cross-reference table e il trailer con i riferimenti ai nuovi oggetti creati e vengono entrambi aggiunti
al pdf originale generando così un nuovo pdf.</p>
<p>Generato il nuovo pdf, avviene la firma dell’originale nel metodo <em>pdf_signer.sign</em>. Viene caricato il certificato dalla smartcard e creati
i signed attributes, che conterranno le informazioni del certificato, come l’ente, il numero seriale, l’algoritmo crittografico utilizzato e file
viene firmato.
Di seguito il codice del metodo :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="n">datau</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">cert</span><span class="p">,</span> <span class="n">cert_value</span><span class="p">,</span> <span class="n">hashalgo</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">signed_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
 <span class="k">if</span> <span class="n">signed_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
     <span class="n">signed_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">hashlib</span><span class="p">,</span> <span class="n">hashalgo</span><span class="p">)(</span><span class="n">datau</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
 <span class="c1"># signed_time = datetime.now() # not needed in signed attributes anymore</span>

 <span class="n">x509</span> <span class="o">=</span> <span class="n">Certificate</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cert_value</span><span class="p">)</span>
 <span class="n">certificates</span> <span class="o">=</span> <span class="p">[]</span>
 <span class="n">certificates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x509</span><span class="p">)</span>

 <span class="n">cert_value_digest</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">cert_value</span><span class="p">,</span> <span class="n">Mechanism</span><span class="p">(</span><span class="n">LowLevel</span><span class="o">.</span><span class="n">CKM_SHA256</span><span class="p">)))</span>
 <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;building signed attributes...&#39;</span><span class="p">)</span>
 <span class="n">signer</span> <span class="o">=</span> <span class="p">{</span>
     <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;v1&#39;</span><span class="p">,</span>
     <span class="s1">&#39;sid&#39;</span><span class="p">:</span> <span class="n">cms</span><span class="o">.</span><span class="n">SignerIdentifier</span><span class="p">({</span>
         <span class="s1">&#39;issuer_and_serial_number&#39;</span><span class="p">:</span> <span class="n">cms</span><span class="o">.</span><span class="n">IssuerAndSerialNumber</span><span class="p">({</span>
             <span class="s1">&#39;issuer&#39;</span><span class="p">:</span> <span class="n">x509</span><span class="o">.</span><span class="n">issuer</span><span class="p">,</span>
             <span class="s1">&#39;serial_number&#39;</span><span class="p">:</span> <span class="n">x509</span><span class="o">.</span><span class="n">serial_number</span><span class="p">,</span>
         <span class="p">}),</span>
     <span class="p">}),</span>
     <span class="s1">&#39;digest_algorithm&#39;</span><span class="p">:</span> <span class="n">algos</span><span class="o">.</span><span class="n">DigestAlgorithm</span><span class="p">({</span><span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="n">hashalgo</span><span class="p">}),</span>
     <span class="s1">&#39;signature_algorithm&#39;</span><span class="p">:</span> <span class="n">algos</span><span class="o">.</span><span class="n">SignedDigestAlgorithm</span><span class="p">({</span><span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="s1">&#39;rsassa_pkcs1v15&#39;</span><span class="p">}),</span>
     <span class="s1">&#39;signature&#39;</span><span class="p">:</span> <span class="n">signed_value</span><span class="p">,</span>
 <span class="p">}</span>
 <span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
     <span class="n">signer</span><span class="p">[</span><span class="s1">&#39;signed_attrs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
         <span class="n">cms</span><span class="o">.</span><span class="n">CMSAttribute</span><span class="p">({</span>
             <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">cms</span><span class="o">.</span><span class="n">CMSAttributeType</span><span class="p">(</span><span class="s1">&#39;content_type&#39;</span><span class="p">),</span>
             <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,),</span>
         <span class="p">}),</span>
         <span class="n">cms</span><span class="o">.</span><span class="n">CMSAttribute</span><span class="p">({</span>
             <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">cms</span><span class="o">.</span><span class="n">CMSAttributeType</span><span class="p">(</span><span class="s1">&#39;message_digest&#39;</span><span class="p">),</span>
             <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">signed_value</span><span class="p">,),</span>
         <span class="p">}),</span>
         <span class="c1"># cms.CMSAttribute({</span>
         <span class="c1">#     &#39;type&#39;: cms.CMSAttributeType(&#39;signing_time&#39;),</span>
         <span class="c1">#     &#39;values&#39;: (cms.Time({&#39;utc_time&#39;: core.UTCTime(signed_time)}),)</span>
         <span class="c1"># }),</span>
         <span class="n">cms</span><span class="o">.</span><span class="n">CMSAttribute</span><span class="p">({</span>
             <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">cms</span><span class="o">.</span><span class="n">CMSAttributeType</span><span class="p">(</span><span class="s1">&#39;1.2.840.113549.1.9.16.2.47&#39;</span><span class="p">),</span>
             <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">tsp</span><span class="o">.</span><span class="n">SigningCertificateV2</span><span class="p">({</span>
                 <span class="s1">&#39;certs&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">tsp</span><span class="o">.</span><span class="n">ESSCertIDv2</span><span class="p">({</span>
                     <span class="s1">&#39;hash_algorithm&#39;</span><span class="p">:</span> <span class="n">algos</span><span class="o">.</span><span class="n">DigestAlgorithm</span><span class="p">({</span><span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="n">hashalgo</span><span class="p">,</span> <span class="s1">&#39;parameters&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}),</span>
                     <span class="s1">&#39;cert_hash&#39;</span><span class="p">:</span> <span class="n">cert_value_digest</span><span class="p">,</span>
                 <span class="p">}),),</span>
             <span class="p">}),)</span>
         <span class="p">}),</span>
     <span class="p">]</span>
 <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
     <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;v1&#39;</span><span class="p">,</span>
     <span class="s1">&#39;digest_algorithms&#39;</span><span class="p">:</span> <span class="n">cms</span><span class="o">.</span><span class="n">DigestAlgorithms</span><span class="p">((</span>
         <span class="n">algos</span><span class="o">.</span><span class="n">DigestAlgorithm</span><span class="p">({</span><span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="n">hashalgo</span><span class="p">}),</span>
     <span class="p">)),</span>
     <span class="s1">&#39;encap_content_info&#39;</span><span class="p">:</span> <span class="p">{</span>
         <span class="s1">&#39;content_type&#39;</span><span class="p">:</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span>
     <span class="p">},</span>
     <span class="s1">&#39;certificates&#39;</span><span class="p">:</span> <span class="n">certificates</span><span class="p">,</span>
     <span class="c1"># &#39;crls&#39;: [],</span>
     <span class="s1">&#39;signer_infos&#39;</span><span class="p">:</span> <span class="p">[</span>
         <span class="n">signer</span><span class="p">,</span>
     <span class="p">],</span>
 <span class="p">}</span>
 <span class="n">datas</span> <span class="o">=</span> <span class="n">cms</span><span class="o">.</span><span class="n">ContentInfo</span><span class="p">({</span>
     <span class="s1">&#39;content_type&#39;</span><span class="p">:</span> <span class="n">cms</span><span class="o">.</span><span class="n">ContentType</span><span class="p">(</span><span class="s1">&#39;signed_data&#39;</span><span class="p">),</span>
     <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">cms</span><span class="o">.</span><span class="n">SignedData</span><span class="p">(</span><span class="n">config</span><span class="p">),</span>
 <span class="p">})</span>
 <span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
     <span class="n">tosign</span> <span class="o">=</span> <span class="n">datas</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">][</span><span class="s1">&#39;signer_infos&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;signed_attrs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span>
     <span class="n">tosign</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x31</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">tosign</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
 <span class="k">else</span><span class="p">:</span>
     <span class="n">tosign</span> <span class="o">=</span> <span class="n">datau</span>

 <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;signed attributes ready&#39;</span><span class="p">)</span>
 <span class="c1"># fetching private key from smart card</span>
 <span class="n">priv_key</span> <span class="o">=</span> <span class="n">SignatureUtils</span><span class="o">.</span><span class="n">fetch_private_key</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">cert</span><span class="p">)</span>
 <span class="n">mechanism</span> <span class="o">=</span> <span class="n">Mechanism</span><span class="p">(</span><span class="n">LowLevel</span><span class="o">.</span><span class="n">CKM_SHA256_RSA_PKCS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
 <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;signing...&#39;</span><span class="p">)</span>
 <span class="c1"># signing bytes to be signed</span>
 <span class="n">signature</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">priv_key</span><span class="p">,</span> <span class="n">tosign</span><span class="p">,</span> <span class="n">mechanism</span><span class="p">)</span>

 <span class="n">datas</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">][</span><span class="s1">&#39;signer_infos&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;signature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span>

 <span class="k">return</span> <span class="n">datas</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span>
</pre></div>
</div>
<p>I bytes firmati vengono sostituiti ai segnaposti nel file generato precedentemente e la firma è conclusa.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datau</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">cert</span><span class="p">,</span> <span class="n">cert_value</span><span class="p">,</span> <span class="n">algomd</span><span class="p">,</span> <span class="n">sig_attributes</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
 <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get certificate in format x509 to build signer attributes&#39;</span><span class="p">)</span>
 <span class="n">x509</span> <span class="o">=</span> <span class="n">Certificate</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cert_value</span><span class="p">)</span>

 <span class="n">sign_name</span> <span class="o">=</span> <span class="n">sig_attributes</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="s1">&#39;signature_name&#39;</span><span class="p">]</span>
 <span class="k">if</span> <span class="n">sign_name</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
     <span class="n">sign_name</span> <span class="o">=</span> <span class="n">MyConfigLoader</span><span class="p">()</span><span class="o">.</span><span class="n">get_pdf_config</span><span class="p">()[</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="s1">&#39;signatureName&#39;</span><span class="p">]</span>

 <span class="n">dct</span> <span class="o">=</span> <span class="p">{</span>
     <span class="sa">b</span><span class="s1">&#39;sigflags&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
     <span class="sa">b</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;%b&#39;</span> <span class="o">%</span> <span class="n">x509</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">native</span><span class="p">[</span><span class="s1">&#39;common_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
     <span class="sa">b</span><span class="s1">&#39;signingdate&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;%b&#39;</span> <span class="o">%</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
     <span class="sa">b</span><span class="s1">&#39;sign_name&#39;</span><span class="p">:</span> <span class="n">sign_name</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
 <span class="p">}</span>

 <span class="c1"># Variabile segnaposto per i bytes che conterranno il file firmato riferimenti della firma</span>
 <span class="n">zeros</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aligned</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)</span>

 <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;start building the new pdf&#39;</span><span class="p">)</span>
 <span class="k">try</span><span class="p">:</span>
     <span class="n">pdfdata2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makepdf</span><span class="p">(</span><span class="n">datau</span><span class="p">,</span> <span class="n">dct</span><span class="p">,</span> <span class="n">zeros</span><span class="p">,</span> <span class="n">sig_attributes</span><span class="p">)</span>
     <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;pdf generated correctly&#39;</span><span class="p">)</span>
 <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
     <span class="k">raise</span> <span class="n">PDFCreationError</span><span class="p">(</span><span class="s1">&#39;Exception on creating pdf&#39;</span><span class="p">)</span>

 <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;preparing data to be signed&#39;</span><span class="p">)</span>
 <span class="n">startxref</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">datau</span><span class="p">)</span>
 <span class="n">pdfbr1</span> <span class="o">=</span> <span class="n">pdfdata2</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">zeros</span><span class="p">)</span>
 <span class="n">pdfbr2</span> <span class="o">=</span> <span class="n">pdfbr1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">zeros</span><span class="p">)</span>
 <span class="n">br</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">startxref</span> <span class="o">+</span> <span class="n">pdfbr1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">startxref</span> <span class="o">+</span> <span class="n">pdfbr2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdfdata2</span><span class="p">)</span> <span class="o">-</span> <span class="n">pdfbr2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
 <span class="n">brfrom</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;[0000000000 0000000000 0000000000 0000000000]&#39;</span>
 <span class="n">brto</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;[</span><span class="si">%010d</span><span class="s1"> </span><span class="si">%010d</span><span class="s1"> </span><span class="si">%010d</span><span class="s1"> </span><span class="si">%010d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">br</span><span class="p">)</span>
 <span class="n">pdfdata2</span> <span class="o">=</span> <span class="n">pdfdata2</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">brfrom</span><span class="p">,</span> <span class="n">brto</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

 <span class="n">b1</span> <span class="o">=</span> <span class="n">pdfdata2</span><span class="p">[:</span><span class="n">br</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">startxref</span><span class="p">]</span>
 <span class="n">b2</span> <span class="o">=</span> <span class="n">pdfdata2</span><span class="p">[</span><span class="n">br</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">startxref</span><span class="p">:]</span>
 <span class="n">md</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">digestSession</span><span class="p">(</span><span class="n">Mechanism</span><span class="p">(</span><span class="n">LowLevel</span><span class="o">.</span><span class="n">CKM_SHA256</span><span class="p">))</span>
 <span class="n">md</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">datau</span><span class="p">)</span>
 <span class="n">md</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span>
 <span class="n">md</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">b2</span><span class="p">)</span>
 <span class="n">md</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">final</span><span class="p">())</span>
 <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;start pdf signing&#39;</span><span class="p">)</span>
 <span class="k">try</span><span class="p">:</span>
     <span class="n">contents</span> <span class="o">=</span> <span class="n">pdf_signer</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">cert</span><span class="p">,</span> <span class="n">cert_value</span><span class="p">,</span> <span class="n">algomd</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">md</span><span class="p">)</span>
     <span class="n">contents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aligned</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
     <span class="n">pdfdata2</span> <span class="o">=</span> <span class="n">pdfdata2</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">zeros</span><span class="p">,</span> <span class="n">contents</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
     <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;pdf signed&#39;</span><span class="p">)</span>
 <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
     <span class="k">raise</span> <span class="n">PDFSigningError</span><span class="p">(</span><span class="s1">&#39;error in the sign procedure&#39;</span><span class="p">)</span>

 <span class="k">return</span> <span class="n">pdfdata2</span>
</pre></div>
</div>
<p>Il file viene salvato sul disco e verificato. Se la procedura va a buon fine verrà restituito il path del file altrimenti viene lanciata
un’eccezione.</p>
<p>Il path del file viene inserito nella lista dei file firmati firmati che saranno inviati nella chiamata http alla servlet di fine firma.
Il file può restare sul disco oppure essere inviato ad un server apposito, in base a questo il path può essere un url al download del file.</p>
<p>Dopo un’operazione di cleanup, viene effettuata la chiamata http alla servlet di fine firma e il flusso è concluso.</p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="digital_signature.html" class="btn btn-neutral float-right" title="Documentazione API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="firma_p7m.html" class="btn btn-neutral float-left" title="Firma P7M" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Giuseppe Russo

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>